<script>
// --- Data ---
let players = []; 
let courts = [];  
let courtCount = 2;
let bookingCounter = 0;
let activeGameResolveCourtId = null;
let pairingHistory = {}; 
let matchLogs = [];

// --- Configuration (Frozen Logic V4.0) ---
const AVG_GAME_DURATION = 15; 
const AUTO_START_DELAY = 30; 

// --- Init ---
function init() {
    renderCourts();
    updateQueueDisplay();
    setInterval(autoFillCourts, 1000);
    updateCustomHoursInputs(); // Init cost calc inputs
}

// --- VIEW SWITCHING ---
function toggleView(viewName) {
    document.getElementById('main-view').classList.add('hidden');
    document.getElementById('overview-view').classList.add('hidden');
    
    if(viewName === 'main') {
        document.getElementById('main-view').classList.remove('hidden');
    } else {
        document.getElementById('overview-view').classList.remove('hidden');
        renderOverview();
    }
}

// --- LOGIC: MATCHMAKING ---
function getPairKey(id1, id2) { return id1 < id2 ? `${id1}-${id2}` : `${id2}-${id1}`; }
function recordPairing(id1, id2) {
    const key = getPairKey(id1, id2);
    if (!pairingHistory[key]) pairingHistory[key] = 0;
    pairingHistory[key]++;
}
function getPairCount(id1, id2) { return pairingHistory[getPairKey(id1, id2)] || 0; }

function addPlayers() {
    const input = document.getElementById('new-players');
    const rawText = input.value.trim();
    if (!rawText) return;
    const names = rawText.split('\n').map(n => n.trim()).filter(n => n);
    let maxGamesInSystem = 0;
    players.forEach(p => { if(p.gamesPlayed > maxGamesInSystem) maxGamesInSystem = p.gamesPlayed; });

    names.forEach(name => {
        let cleanName = name.replace(/^[\d]+\.[\s]*/, '');
        let joinTime = Date.now();
        let isFastPass = false;
        if (maxGamesInSystem > 2) {
            joinTime = Date.now() - (60 * 60 * 1000); 
            isFastPass = true;
        }
        players.push({
            id: Date.now() + Math.random(),
            name: cleanName,
            gamesPlayed: 0,
            wins: 0,
            status: 'waiting',
            joinedQueueAt: joinTime, 
            bookingId: null,
            sessionGames: 0,
            isFastPass: isFastPass,
            checkInTime: new Date()
        });
    });
    input.value = '';
    updateQueueDisplay();
}

const removePlayer = (id) => {
    const p = players.find(x => x.id === id);
    if (!p) return;

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö
    if(p.status === 'playing') { alert('‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö'); return; }

    // ‚ú® NEW: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ö‡∏±‡πä‡∏Å
    if (p.bookingId) {
        const others = players.filter(x => x.bookingId === p.bookingId && x.id !== id);
        if (others.length > 0) {
            if(!confirm(`‚ö†Ô∏è ${p.name} ‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö (${others.map(o=>o.name).join(', ')}) \n‡∏ñ‡πâ‡∏≤‡∏•‡∏ö Booking ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏´‡∏°?`)) return;
            
            // ‡∏•‡πâ‡∏≤‡∏á Booking ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏™‡∏î)
            players.forEach(x => {
                if(x.bookingId === p.bookingId) {
                    x.bookingId = null;
                    x.bookingTeam = null;
                }
            });
        }
    } else {
        if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${p.name} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;
    }

    // ‡∏•‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå
    players = players.filter(p => p.id !== id);
    updateQueueDisplay();
};
}

function resetStatsOnly() {
    if(!confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?')) return;
    players.forEach(p => { 
        p.gamesPlayed = 0; p.wins = 0; p.sessionGames = 0; 
        p.status = 'waiting'; p.joinedQueueAt = Date.now(); p.bookingId = null; p.isFastPass = false;
    });
    pairingHistory = {};
    matchLogs = [];
    renderMatchLog();
    resetCourtsState();
    updateQueueDisplay();
}

function resetAll() {
    if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
    players = [];
    pairingHistory = {};
    matchLogs = [];
    renderMatchLog();
    resetCourtsState();
    updateQueueDisplay();
}

function resetCourtsState() {
    courts.forEach(c => {
        clearInterval(c.interval);
        c.players = []; c.state = 'empty'; c.timer = 0; c.isOpened = false; c.autoStartTarget = null;
    });
    renderCourts();
}

function updateCourts(change) {
    const newCount = courtCount + change;
    if (newCount < 1) return;
    courtCount = newCount;
    document.getElementById('court-count').innerText = courtCount;
    document.getElementById('calc-court-count').value = courtCount;
    updateCustomHoursInputs();
    renderCourts();
}

function renderCourts() {
    const container = document.getElementById('courts-container');
    if (courts.length < courtCount) {
        for (let i = courts.length; i < courtCount; i++) {
            courts.push({ id: i, players: [], state: 'empty', timer: 0, interval: null, isOpened: false, autoStartTarget: null });
        }
    } else if (courts.length > courtCount) {
        const removed = courts.pop();
            if (removed.players.length > 0) {
            removed.players.forEach(p => {
                const pl = players.find(x => x.id === p.id);
                if(pl) { pl.status = 'waiting'; pl.joinedQueueAt = Date.now(); pl.sessionGames = 0; }
            });
        }
    }
    container.innerHTML = '';
    courts.forEach((court, index) => {
        let overlayHTML = '';
        if (court.state === 'post_game') {
            overlayHTML = `
                <div class="court-overlay">
                    <button class="btn-overlay btn-call" onclick="triggerFill(${index})">üì¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á</button>
                    <button class="btn-overlay btn-rest" onclick="closeAndRest(${index})">üî¥ ‡∏û‡∏±‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</button>
                </div>
            `;
        } else if (!court.isOpened) {
            overlayHTML = `
                <div class="court-overlay">
                    <button class="btn-overlay btn-open" onclick="openCourt(${index})">üîî ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°</button>
                </div>
            `;
        }
        const courtHTML = `
            <div class="court" id="court-${index}">
                <div class="court-lines"></div>
                <div class="service-line-top"></div>
                <div class="service-line-bottom"></div>
                <div class="court-header"><span>#${index + 1}</span><small>${getRuleLabel()}</small></div>
                ${overlayHTML}
                <div class="court-players">
                    <div class="team team-pink">${renderPlayerOnCourt(court.players[0], index, 0)}${renderPlayerOnCourt(court.players[1], index, 1)}</div>
                    <div class="team team-blue">${renderPlayerOnCourt(court.players[2], index, 2)}${renderPlayerOnCourt(court.players[3], index, 3)}</div>
                </div>
                <div class="court-controls">
                    <div class="timer" id="timer-${index}">${formatTime(court.timer)}</div>
                    ${renderCourtButtons(court, index)}
                </div>
            </div>
        `;
        container.innerHTML += courtHTML;
    });
    updateQueueDisplay();
    updateDashboard(); 
}

function openCourt(idx) { courts[idx].isOpened = true; renderCourts(); }
function triggerFill(idx) { courts[idx].state = 'empty'; renderCourts(); }
function closeAndRest(idx) {
    courts[idx].players.forEach(p => sendToQueue(p.id));
    courts[idx].players = []; courts[idx].state = 'empty'; courts[idx].isOpened = false; courts[idx].timer = 0;
    renderCourts();
}
function getRuleLabel() { return document.getElementById('game-rule').value === 'winner_stay' ? "Fixed Quota" : ""; }
function renderPlayerOnCourt(player, courtIdx, slotIdx) {
    if (!player) return '<div class="player-on-court" style="opacity:0.5; background:#eee; color:#aaa; border:none;">‡∏ß‡πà‡∏≤‡∏á</div>';
    const rule = document.getElementById('game-rule').value;
    let badge = (rule === 'winner_stay') ? `<span class="quota-badge" style="background:${player.sessionGames >= 1 ? '#e67e22' : '#27ae60'}">G: ${player.sessionGames + 1}/2</span>` : '';
    return `<div class="player-on-court" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß" onclick="kickPlayer(${courtIdx}, ${slotIdx})"><strong>${player.name}</strong><span style="font-size:0.8em; margin-top:2px;">(${player.gamesPlayed}P)</span>${badge}</div>`;
}
function renderCourtButtons(court, idx) {
    if (!court.isOpened || court.state === 'post_game') return `<button class="secondary" style="width:100%;" disabled>...</button>`;
    
    if (court.state === 'playing') return `<button class="danger" style="width:100%;" onclick="stopGame(${idx})">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>`;

    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö 4 (‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°)
    if (court.players.length === 4) {
        if (court.autoStartTarget) {
            const remaining = Math.ceil((court.autoStartTarget - Date.now()) / 1000);
            if (remaining > 0) return `<button class="success btn-auto-start" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${remaining}s)</button>`;
        }
        return `<button class="success" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>`;
    } 
    
// ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...

// --- ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ó‡πà‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î) ---
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
    const waiting = players.filter(p => p.status === 'waiting').sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Booking ‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° (‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î)
    const firstP = waiting.length > 0 ? waiting[0] : null;
    const bookingGroup = firstP && firstP.bookingId ? players.filter(p => p.bookingId === firstP.bookingId && p.status === 'waiting') : [];
    
    const needed = 4 - court.players.length;
    let buttonsHTML = '';

    // ‚ú® ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Booking ‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞ "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏û‡∏≠‡∏î‡∏µ" ‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á -> ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
    if (bookingGroup.length > 0 && bookingGroup.length <= needed) {
        buttonsHTML += `
            <button style="background:#9b59b6; color:white; flex:1.5;" onclick="fillCourtSmart(${idx})">
                üîí ‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≠‡∏á (${bookingGroup.length} ‡∏Ñ‡∏ô)
            </button>
        `;
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Booking ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -> ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        buttonsHTML += `<button class="warning" style="flex:1;" onclick="fillCourtSmart(${idx})">üé≤ ‡∏™‡∏∏‡πà‡∏°</button>`;
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß (‡∏™‡∏µ‡∏ü‡πâ‡∏≤) ‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏≠
    buttonsHTML += `<button style="background:#3498db; color:white; flex:1;" onclick="fillCourtQueue(${idx})">‚è© ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß</button>`;

    return `<div style="display:flex; gap:5px;">${buttonsHTML}</div>`;
}

// --- üß† SMART AUTO FILL (V5.1 Wave's Logic) ---
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏Ñ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
const autoFillCourts = () => {
    courts.forEach((court, idx) => {
        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•
        if (!court.isOpened || court.state === 'playing' || court.state === 'post_game') return;

        // --- ‚ùå LOGIC ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß --- 

        // ‚úÖ LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö 4 ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)
        if (court.players.length === 4) {
            if (!court.autoStartTarget) { 
                court.autoStartTarget = Date.now() + (AUTO_START_DELAY * 1000); 
                renderCourts(); 
            }
            else if (Date.now() >= court.autoStartTarget) { 
                startGame(idx); 
            }
            else {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Real-time
                const btn = document.querySelector(`#court-${idx} .btn-auto-start`);
                if (btn) btn.innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${Math.ceil((court.autoStartTarget - Date.now()) / 1000)}s)`;
            }
        } else {
             // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å) ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
             court.autoStartTarget = null;
        }
    });
};
// ‡∏õ‡∏∏‡πà‡∏° 1: ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏â‡∏•‡∏≤‡∏î‡πÜ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥/‡πÄ‡∏ä‡πá‡∏Ñ Booking)
const fillCourtSmart = (courtIdx) => {
    const court = courts[courtIdx];
    const needed = 4 - court.players.length;
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏° (getSmartDraft)
    const candidates = getSmartDraft(needed);
    
    if (candidates.length > 0) {
        candidates.forEach(p => {
            p.status = 'playing';
            p.sessionGames = 0;
            if(p.isFastPass) p.isFastPass = false;
            court.players.push(p);
        });
        renderCourts();
    } else {
        alert('‚ö†Ô∏è ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥!');
    }
};

// ‡∏õ‡∏∏‡πà‡∏° 2: ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß (‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏•‡∏π‡∏Å‡πÉ‡∏Ñ‡∏£)
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß" ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Booking Safe)
const fillCourtQueue = (courtIdx) => {
    const court = courts[courtIdx];
    const needed = 4 - court.players.length;
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤)
    const waiting = players
        .filter(p => p.status === 'waiting')
        .sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);

    if (waiting.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö'); return; }

    // ‡∏î‡∏π‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
    const firstP = waiting[0];
    let candidates = [];

    // üõ°Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å "‡∏°‡∏µ Booking" (‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà/‡∏ó‡∏µ‡∏°)
    if (firstP.bookingId) {
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏Å‡πä‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤
        const group = waiting.filter(p => p.bookingId === firstP.bookingId);
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏≠‡πÑ‡∏´‡∏°?
        if (group.length > needed) {
            alert(`‚ö†Ô∏è ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠ Booking (${group.length} ‡∏Ñ‡∏ô) ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà ${needed} ‡∏ó‡∏µ‡πà`);
            return; // ‚ùå ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡πâ‡∏≤‡∏°‡∏â‡∏µ‡∏Å‡∏Ñ‡∏π‡πà
        }
        candidates = group;
    } 
    // üõ°Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å "‡∏°‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß" (‡πÑ‡∏°‡πà‡∏°‡∏µ Booking)
    else {
        // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏õ‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ Booking
        for (let i = 0; i < waiting.length; i++) {
            if (candidates.length >= needed) break; // ‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            
            const p = waiting[i];
            if (p.bookingId) break; // ‚úã ‡∏´‡∏¢‡∏∏‡∏î! ‡∏ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ Booking (‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏≠‡∏≤ Booking ‡∏•‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
            
            candidates.push(p);
        }
    }

    // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°
    if (candidates.length > 0) {
        candidates.forEach(p => {
            p.status = 'playing';
            p.sessionGames = 0;
            if(p.isFastPass) p.isFastPass = false;
            court.players.push(p);
        });
        renderCourts();
    }
};
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á)
function getSmartDraft(count) {
    let pool = players.filter(p => p.status === 'waiting');
    pool.sort((a, b) => a.joinedQueueAt - b.joinedQueueAt); 

    let selected = [];
    let usedIds = new Set();
    
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (count)
    while (selected.length < count) {
        // 1. ‡∏´‡∏≤ "Captain" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏≥‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        // (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° Booking ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏î‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏û‡∏≠‡∏î‡∏µ)
        let captain = null;
        
        for (let i = 0; i < pool.length; i++) {
            const p = pool[i];
            
            // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            if (usedIds.has(p.id)) continue;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
            if (p.bookingId) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á
                const group = pool.filter(x => x.bookingId === p.bookingId);
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≠‡∏á 4)
                group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));

                // üìå ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ "‡∏¢‡∏±‡∏î‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠" ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?
                // ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏î 1 ‡πÅ‡∏ï‡πà‡∏°‡∏≤ 2 -> (2 <= 1) ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πá‡∏à -> ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!
                if (group.length <= (count - selected.length)) {
                    captain = p; // ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô! ‡πÄ‡∏≠‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏Å‡πä‡∏á
                    break; 
                }
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏•‡∏π‡∏õ‡∏à‡∏∞‡∏ß‡∏ô‡πÑ‡∏õ‡∏î‡∏π‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏≠‡∏á (Skip)
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ‡∏¢‡∏±‡∏î‡∏•‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Loop while ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                captain = p;
                break;
            }
        }

        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏à‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏ó‡∏µ‡πà ‡πÅ‡∏ï‡πà‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏¥‡∏ß‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ñ‡∏π‡πà‡∏à‡∏≠‡∏á)
        if (!captain) break;

        // 2. ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏á‡∏°‡∏≤ (Captain ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏£‡∏Ñ‡∏û‡∏ß‡∏Å)
        if (captain.bookingId) {
            // ‡πÄ‡∏Ñ‡∏™‡∏à‡∏≠‡∏á: ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏Å‡πä‡∏á
            const group = pool.filter(x => x.bookingId === captain.bookingId);
            group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));
            
            group.forEach(p => {
                if (!usedIds.has(p.id)) {
                    selected.push(p);
                    usedIds.add(p.id);
                }
            });
        } else {
            // ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß: ‡πÄ‡∏≠‡∏≤‡∏•‡∏á‡∏°‡∏≤ 1 ‡∏Ñ‡∏ô
            selected.push(captain);
            usedIds.add(captain.id);

            // 3. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 2 ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß 1 ‡πÇ‡∏™‡∏î) -> ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏π‡πà Smart Partner
            // Logic ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ Booking ‡∏ô‡∏∞)
            while (selected.length < count) {
                 // ‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏î‡∏∂‡∏á‡∏•‡∏á‡∏°‡∏≤
                 let currentLast = selected[selected.length - 1];
                 let partner = findBestPartnerInfinite(currentLast, pool, usedIds);
                 
                 if (partner) {
                     selected.push(partner);
                     usedIds.add(partner.id);
                 } else {
                     // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ‡∏´‡∏¢‡∏¥‡∏ö‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ó‡∏ô
                     break; 
                 }
            }
        }
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
    if (selected.length === count) return selected;
    
    // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏î 1 ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ñ‡∏π‡πà‡∏à‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ)
    console.warn("‡∏´‡∏≤‡∏Ñ‡∏ô‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Booking)");
    return [];
}

    // ... (‡∏™‡πà‡∏ß‡∏ô Logic ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏Ñ‡∏π‡πà ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
    let selected = [];
    let usedIds = new Set();
    
    let captain = pool[0];
    selected.push(captain);
    usedIds.add(captain.id);

    while (selected.length < count && selected.length < pool.length) {
        let nextPlayer = null;

        if (selected.length % 2 !== 0) {
            let currentSolo = selected[selected.length - 1];
            nextPlayer = findBestPartnerInfinite(currentSolo, pool, usedIds);
        } else {
            nextPlayer = pool.find(p => !usedIds.has(p.id) && !p.bookingId); 
        }

        if (nextPlayer) {
            selected.push(nextPlayer);
            usedIds.add(nextPlayer.id);
        } else {
            let fallback = pool.find(p => !usedIds.has(p.id));
            if (fallback) { selected.push(fallback); usedIds.add(fallback.id); }
            else break;
        }
    }
    return selected;
}

function findBestPartnerInfinite(captain, fullPool, usedIds) {
    let best = null; 
    let minScore = Infinity;
    
    for (let i = 0; i < fullPool.length; i++) {
        const c = fullPool[i];
        
        if (c.id === captain.id || usedIds.has(c.id) || c.bookingId) continue; 
        
        const count = getPairCount(captain.id, c.id);
        const penalty = (count >= 2) ? 999999999 : count * 1000000;
        const score = penalty + i; 
        
        if (score < minScore) { 
            minScore = score; 
            best = c; 
        }
    }
    return best;
}

function startGame(courtIdx) {
    const court = courts[courtIdx]; court.state = 'playing'; court.timer = 0; court.autoStartTarget = null; 
    if(court.players[0] && court.players[1]) recordPairing(court.players[0].id, court.players[1].id);
    if(court.players[2] && court.players[3]) recordPairing(court.players[2].id, court.players[3].id);
    court.interval = setInterval(() => { court.timer++; document.getElementById(`timer-${courtIdx}`).innerText = formatTime(court.timer); }, 1000);
    renderCourts();
}

function stopGame(courtIdx) {
    const court = courts[courtIdx]; clearInterval(court.interval);
    court.players.forEach(p => { const pl = players.find(x => x.id === p.id); if(pl) { pl.gamesPlayed++; pl.sessionGames++; } });
    activeGameResolveCourtId = courtIdx; document.getElementById('winner-modal').style.display = 'flex';
}

function cancelStopGame() {
    const court = courts[activeGameResolveCourtId];
    court.players.forEach(p => { const pl = players.find(x => x.id === p.id); if(pl) { pl.gamesPlayed--; pl.sessionGames--; } });
    court.interval = setInterval(() => { court.timer++; document.getElementById(`timer-${activeGameResolveCourtId}`).innerText = formatTime(court.timer); }, 1000);
    document.getElementById('winner-modal').style.display = 'none'; activeGameResolveCourtId = null; renderCourts();
}

function resolveGame(winningTeamIdx) { 
    const court = courts[activeGameResolveCourtId]; 
    document.getElementById('winner-modal').style.display = 'none';

    // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Å‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞/‡πÅ‡∏û‡πâ) -> ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
    if (winningTeamIdx === -1) { 
        court.players.forEach(p => sendToQueue(p.id)); 
        court.players = []; 
        court.state = 'post_game'; 
    } 
    // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏°‡∏µ‡πÅ‡∏û‡πâ/‡∏ä‡∏ô‡∏∞
    else {
        const t1 = [court.players[0], court.players[1]]; 
        const t2 = [court.players[2], court.players[3]]; 
        
        let winners = (winningTeamIdx === 0) ? t1 : t2; 
        let losers = (winningTeamIdx === 0) ? t2 : t1;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
        matchLogs.unshift({ 
            time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}), 
            court: activeGameResolveCourtId+1, 
            winners: winners.map(p=>p.name).join(', '), 
            losers: losers.map(p=>p.name).join(', '), 
            duration: formatTime(court.timer) 
        });
        renderMatchLog();
        
        // ‡∏ö‡∏ß‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏ô‡∏∞
        winners.forEach(p => { 
            const pl = players.find(x => x.id === p.id); 
            if(pl) pl.wins++; 
        });

        let stayers = [], leavers = [];
        
        // --- üîç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô! ---
        const rule = document.getElementById('game-rule').value;

        if (rule === 'normal') {
            // ‡πÇ‡∏´‡∏°‡∏î Normal: ‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏•‡∏π‡∏Å‡πÉ‡∏Ñ‡∏£!
            leavers.push(...t1, ...t2);
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î Fixed Quota (Winner Stay ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ 2 ‡πÄ‡∏Å‡∏°)
            const q1 = players.find(x => x.id === t1[0].id).sessionGames; 
            const q2 = players.find(x => x.id === t2[0].id).sessionGames;

            if (q1 < 2 && q2 < 2) { 
                // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà -> ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠, ‡∏ú‡∏π‡πâ‡πÅ‡∏û‡πâ‡∏≠‡∏≠‡∏Å
                if (winningTeamIdx === 0) { stayers.push(...t1); leavers.push(...t2); } 
                else { stayers.push(...t2); leavers.push(...t1); } 
            } else { 
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (‡∏Ñ‡∏£‡∏ö 2 ‡πÄ‡∏Å‡∏°) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
                if (q1 >= 2) leavers.push(...t1); else stayers.push(...t1); 
                if (q2 >= 2) leavers.push(...t2); else stayers.push(...t2); 
            }
        }
        
        // ‡∏™‡∏±‡πà‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ô
        leavers.forEach(p => sendToQueue(p.id)); 
        court.players = [...stayers]; 
        court.state = 'post_game';
    }
    court.timer = 0; 
    renderCourts();
}

function sendToQueue(playerId) { const pl = players.find(x => x.id === playerId); if(pl) { pl.status = 'waiting'; pl.joinedQueueAt = Date.now(); pl.bookingId = null; pl.bookingTeam = null; pl.sessionGames = 0; } }
// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Modern Syntax (Arrow Function)
const kickPlayer = (courtIdx, slotIdx) => {
    const court = courts[courtIdx];
    const player = court.players[slotIdx];

    // ‡πÉ‡∏ä‡πâ Template Literals (`...`) ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ String
    if (!player || !confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß ${player.name} ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;

    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß (Logic ‡πÄ‡∏î‡∏¥‡∏°)
    sendToQueue(player.id);
    
    // 2. ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ô‡∏≤‡∏°
    // ‡πÉ‡∏ä‡πâ array.splice ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô
    court.players.splice(slotIdx, 1);
    
    // 3. ‚ú® NEW LOGIC: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! ‚ú®
    if (court.state === 'playing') {
        // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        clearInterval(court.interval);
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 'empty' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ autoFill ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
        court.state = 'empty'; 
        
        // Reset ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ visual ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î
        // (‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô court.timer ‡∏ô‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
        console.log(`Game paused at ${court.timer}s`);
    }
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Auto Start (‡∏Å‡∏±‡∏ô‡∏°‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏°‡∏±‡πà‡∏ß)
    court.autoStartTarget = null;
    
    // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
    renderCourts();
};
// --- UI HELPERS ---
function renderMatchLog() {
    const tbody = document.getElementById('match-log-body');
    if (matchLogs.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:gray;">-</td></tr>'; return; }
    tbody.innerHTML = matchLogs.map(log => `<tr><td>${log.time}</td><td>${log.court}</td><td class="log-winner">${log.winners}</td><td class="log-loser">${log.losers}</td><td>${log.duration}</td></tr>`).join('');
}

function updateDashboard() {
    const tbody = document.getElementById('stats-body');
    const sortType = document.getElementById('sort-select').value;
    
    let sorted = [...players].sort((a, b) => {
        if (sortType === 'games_desc') return b.gamesPlayed - a.gamesPlayed;
        if (sortType === 'games_asc') return a.gamesPlayed - b.gamesPlayed;
        if (sortType === 'wins_desc') return b.wins - a.wins;
        return 0;
    });

    tbody.innerHTML = sorted.map((p, index) => {
        let rank = index + 1;
        let medal = '';
        if (rank === 1) medal = 'ü•á'; else if (rank === 2) medal = 'ü•à'; else if (rank === 3) medal = 'ü•â';
        const rate = p.gamesPlayed > 0 ? Math.round((p.wins / p.gamesPlayed) * 100) : 0;
        return `<tr><td>${medal} ${rank}</td><td>${p.name}</td><td>${p.gamesPlayed}</td><td>${p.wins}</td><td>${rate}%</td></tr>`;
    }).join('');
}

// --- OVERVIEW & COST ---
function renderOverview() {
    const statsBody = document.getElementById('overview-stats-body');
    const repeatBody = document.getElementById('overview-repeat-body');
    
    statsBody.innerHTML = players.map(p => {
        let time = p.checkInTime ? new Date(p.checkInTime).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-';
        return `<tr><td style="text-align:left">${p.name}</td><td>${time}</td><td>${p.gamesPlayed}</td><td>${p.wins}</td></tr>`;
    }).join('');

    let repeats = [];
    for (const [key, count] of Object.entries(pairingHistory)) {
        if (count > 1) {
            const [id1, id2] = key.split('-');
            const p1 = players.find(p => p.id == id1); const p2 = players.find(p => p.id == id2);
            if (p1 && p2) repeats.push({ name: `${p1.name} + ${p2.name}`, count: count });
        }
    }
    repeats.sort((a, b) => b.count - a.count);
    repeatBody.innerHTML = repeats.length === 0 ? '<tr><td colspan="2" style="color:green;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥</td></tr>' : repeats.map(s => `<tr><td style="text-align:left;">${s.name}</td><td style="color:#e65100; font-weight:bold;">${s.count}</td></tr>`).join('');

    updateCost();
}

let isCustomHours = false;
function toggleCustomHours() {
    isCustomHours = !isCustomHours;
    document.getElementById('custom-hours-area').style.display = isCustomHours ? 'block' : 'none';
    document.getElementById('std-hours-group').style.display = isCustomHours ? 'none' : 'flex';
    updateCustomHoursInputs();
    updateCost();
}

function updateCustomHoursInputs() {
    const area = document.getElementById('custom-hours-area');
    area.innerHTML = '';
    for(let i=0; i<courtCount; i++) {
        area.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label>‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${i+1}:</label><input type="number" class="court-hr-input" value="2" style="width:50px;" onchange="updateCost()"> ‡∏ä‡∏°.</div>`;
    }
}

// ==========================================
// üí∞ LOGIC ‡∏´‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏ü‡∏£‡πå‡πÜ (Time-based)
// ==========================================

function updateCost() {
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Grand Total) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞
    const pricePerHr = parseFloat(document.getElementById('calc-court-price').value) || 0;
    let totalHours = 0;

    if (isCustomHours) {
        document.querySelectorAll('.court-hr-input').forEach(inp => totalHours += parseFloat(inp.value) || 0);
    } else {
        totalHours = (parseFloat(document.getElementById('calc-hours').value) || 0) * (parseFloat(document.getElementById('calc-court-count').value) || 0);
    }

    const shuttlePrice = parseFloat(document.getElementById('calc-shuttle-price').value) || 0;
    const shuttleUsed = parseFloat(document.getElementById('calc-shuttle-used').value) || 0;
    const shuttleTotal = (shuttlePrice / 12) * shuttleUsed;

    const grandTotal = (totalHours * pricePerHr) + shuttleTotal;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    document.getElementById('total-cost-display').innerText = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

    // 2. --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô ---
    const now = new Date();
    let totalMinutesAllPlayers = 0;

    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ)
    players.forEach(p => {
        if (p.checkInTime) {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Check-in ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ)
            const diffMs = now - new Date(p.checkInTime);
            p.minutesPresent = Math.max(1, Math.floor(diffMs / 60000)); // ‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ô‡∏≤‡∏ó‡∏µ
        } else {
            p.minutesPresent = 0; 
        }
        totalMinutesAllPlayers += p.minutesPresent;
    });

    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡πÑ‡∏ï‡∏£‡∏¢‡∏≤‡∏á‡∏®‡πå (‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏π / ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) * ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°
    players.forEach(p => {
        if (totalMinutesAllPlayers > 0 && grandTotal > 0) {
            p.calculatedCost = (p.minutesPresent / totalMinutesAllPlayers) * grandTotal;
        } else {
            p.calculatedCost = 0;
        }
    });

    // 3. ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏™‡πà‡∏á true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateCost ‡∏ã‡πâ‡∏≥)
    renderOverview(true); 
}

function renderOverview(skipUpdateCost = false) {
    const statsBody = document.getElementById('overview-stats-body');
    const repeatBody = document.getElementById('overview-repeat-body');
    
    // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
    statsBody.innerHTML = players.map(p => {
        let time = p.checkInTime ? new Date(p.checkInTime).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-';
        // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡πÜ (Ceil = ‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏®‡∏©‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
        let costShow = p.calculatedCost ? Math.ceil(p.calculatedCost) : 0; 
        
        return `
            <tr>
                <td style="text-align:left">
                    ${p.name} 
                    <div style="font-size:0.75em; color:gray;">(‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏≤ ${p.minutesPresent || 0} ‡∏ô.)</div>
                </td>
                <td>${time}</td>
                <td>${p.gamesPlayed}</td>
                <td>${p.wins}</td>
                <td style="font-weight:bold; color:#27ae60;">${costShow} ‡∏ø</td>
            </tr>`;
    }).join('');

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    let repeats = [];
    for (const [key, count] of Object.entries(pairingHistory)) {
        if (count > 1) {
            const [id1, id2] = key.split('-');
            const p1 = players.find(p => p.id == id1); const p2 = players.find(p => p.id == id2);
            if (p1 && p2) repeats.push({ name: `${p1.name} + ${p2.name}`, count: count });
        }
    }
    repeats.sort((a, b) => b.count - a.count);
    repeatBody.innerHTML = repeats.length === 0 ? '<tr><td colspan="2" style="color:green;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥</td></tr>' : repeats.map(s => `<tr><td style="text-align:left;">${s.name}</td><td style="color:#e65100; font-weight:bold;">${s.count}</td></tr>`).join('');

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateCost ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å updateCost (‡∏Å‡∏±‡∏ô Loop ‡∏ô‡∏£‡∏Å)
    if (!skipUpdateCost) updateCost();
}

function endSession() {
    const element = document.getElementById("summary-capture-area");
    html2canvas(element).then(canvas => {
        const link = document.createElement('a');
        link.download = 'badminton-summary.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

// Modal & Queue
let currentBookingType = '';
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏ó‡∏µ‡∏° ‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
const openBookingModal = (type) => {
    currentBookingType = type;
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á
    const waiting = players
        .filter(p => p.status === 'waiting' && !p.bookingId)
        .sort((a,b) => a.joinedQueueAt - b.joinedQueueAt); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown
    const options = waiting.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    
    let html = '';
    if (type === 'pair') {
        html += `<h4>üë• ‡∏à‡∏≠‡∏á‡∏Ñ‡∏π‡πà (2 ‡∏Ñ‡∏ô)</h4>`;
        html += `<label>‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å:</label><select id="b-p1" style="width:100%; margin-bottom:10px; padding:5px;">${options}</select>`;
        html += `<label>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á:</label><select id="b-p2" style="width:100%; margin-bottom:10px; padding:5px;">${options}</select>`;
    } else { // match (4 ‡∏Ñ‡∏ô)
        html += `<h4>‚öîÔ∏è ‡∏à‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå (4 ‡∏Ñ‡∏ô / 2 ‡∏ó‡∏µ‡∏°)</h4>`;
        
        // Team 1 (‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π)
        html += `<div style="background:#ffcdd2; padding:10px; border-radius:8px; margin-bottom:10px;">`;
        html += `<strong style="color:#b71c1c;">Team 1 (‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π):</strong>`;
        html += `<select id="b-p1" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `<select id="b-p2" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `</div>`;
        
        // Team 2 (‡∏™‡∏µ‡∏ü‡πâ‡∏≤)
        html += `<div style="background:#bbdefb; padding:10px; border-radius:8px;">`;
        html += `<strong style="color:#0d47a1;">Team 2 (‡∏™‡∏µ‡∏ü‡πâ‡∏≤):</strong>`;
        html += `<select id="b-p3" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `<select id="b-p4" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `</div>`;
    }
    
    document.getElementById('booking-inputs').innerHTML = html; 
    document.getElementById('booking-modal').style.display = 'flex';
};
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Team (1 ‡∏´‡∏£‡∏∑‡∏≠ 2) ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
const confirmBooking = () => {
    const ids = [];
    if (currentBookingType === 'pair') {
        ids.push({id: document.getElementById('b-p1').value, team: 1});
        ids.push({id: document.getElementById('b-p2').value, team: 1});
    } else {
        ids.push({id: document.getElementById('b-p1').value, team: 1}); // T1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1
        ids.push({id: document.getElementById('b-p2').value, team: 1}); // T1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2
        ids.push({id: document.getElementById('b-p3').value, team: 2}); // T2 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1
        ids.push({id: document.getElementById('b-p4').value, team: 2}); // T2 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2
    }

    // ‡∏î‡∏±‡∏Å Error: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ã‡πâ‡∏≥!
    const unique = new Set(ids.map(x => x.id));
    if (unique.size !== ids.length) { alert('‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!'); return; }

    const bId = 'book-' + (++bookingCounter);
    
    ids.forEach(x => {
        const p = players.find(pl => pl.id == x.id);
        if (p) {
            p.bookingId = bId;
            p.bookingTeam = x.team; // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        }
    });

    closeModal('booking-modal'); 
    updateQueueDisplay();
};
function updateQueueDisplay() {
    const list = document.getElementById('player-queue');
    const waiting = players.filter(p => p.status === 'waiting');
    waiting.sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);
    document.getElementById('queue-count').innerText = waiting.length;
    list.innerHTML = waiting.map(p => {
        let badgeClass = 'wait-green'; let badgeText = '<5m';
        const min = (players.indexOf(p) + 1) * (AVG_GAME_DURATION / (courtCount * 2));
        if (min > 10) { badgeClass = 'wait-red'; badgeText = '>10m'; } else if (min >= 5) { badgeClass = 'wait-orange'; badgeText = '5-10m'; }
        return `<li class="player-item ${p.bookingId ? 'booked' : ''} ${p.isFastPass ? 'fastpass' : ''}"><div class="player-info"><strong>${p.isFastPass?'üöÄ ':''}${p.name}</strong>$${p.bookingId ? `<small style="cursor:pointer; font-size:1.2em;" onclick="cancelBooking('${p.bookingId}')" title="‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á">üîí</small>` : ''}<span class="wait-badge ${badgeClass}">${badgeText}</span></div><button class="mini-btn danger" onclick="removePlayer(${p.id})">√ó</button></li>`;
    }).join('');
}
function formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à)
const cancelBooking = (bId) => {
    // ‡∏´‡∏≤‡∏î‡∏π‡∏ã‡∏¥‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á
    const group = players.filter(p => p.bookingId === bId);
    if(group.length === 0) return;

    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ (${group.map(p=>p.name).join(', ')}) ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? \n(‡∏Ñ‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)`)) return;
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Booking ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
    players.forEach(p => {
        if(p.bookingId === bId) {
            p.bookingId = null;
            p.bookingTeam = null;
        }
    });
    updateQueueDisplay();
};
init();
</script>