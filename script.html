<script>
  // --- Persistence & State Management ---
const STORAGE_KEY = 'BADMINTON_MANAGER_V7_DATA';


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô UI Freeze)
function isModalOpen() {
    const booking = document.getElementById('booking-modal');
    const winner = document.getElementById('winner-modal');
    return (booking && booking.style.display === 'flex') || (winner && winner.style.display === 'flex');
}


// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
function saveData() {
    const data = {
        players,
        courts: courts.map(c => ({...c, interval: null})), // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å interval object
        courtCount,
        pairingHistory,
        opponentHistory,
        matchLogs,
        bookingCounter,
        gameRule: document.getElementById('game-rule').value,
        rankedMode: isRankedMode, // ‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ
        completedGameTimes // ‚ú® NEW: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}


// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;


    try {
        const data = JSON.parse(raw);
        players = data.players || [];
        courtCount = data.courtCount || 2;
        pairingHistory = data.pairingHistory || {};
        opponentHistory = data.opponentHistory || {};
        matchLogs = data.matchLogs || [];
        bookingCounter = data.bookingCounter || 0;
       
       // ‚ú® Restore Ranked Mode
        if (typeof data.rankedMode !== 'undefined') {
            isRankedMode = data.rankedMode;
            const cb = document.getElementById('ranked-mode-toggle');
            if (cb) cb.checked = isRankedMode;
        }

        return true;

        // Restore Courts
        if (data.courts) {
            courts = data.courts.map((c, index) => { // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏° index
                c.interval = null;
                if (!c.rule) c.rule = 'normal'; // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
               
                // ‚è∞ ‡∏õ‡∏•‡∏∏‡∏Å‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà" ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
                if (c.state === 'playing') {
                    c.interval = setInterval(() => {
                        c.timer++;
                        const el = document.getElementById(`timer-${index}`);
                        if(el) el.innerText = formatTime(c.timer);
                    }, 1000);
                }
                return c;
            });
        }
       
        // Restore Rule
        if (data.gameRule) {
            const ruleSelect = document.getElementById('game-rule');
            if(ruleSelect) ruleSelect.value = data.gameRule;
        }
        if (data.completedGameTimes) completedGameTimes = data.completedGameTimes; // ‚ú® NEW

        return true;
    } catch (e) {
        console.error("Load Data Error:", e);
        return false;
    }
}
  // ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
const countRealPlayers = (court) => {
    return court.players.filter(p => p !== null && p !== undefined).length;
};
// --- ‚öñÔ∏è LEVEL & BALANCING SYSTEM (Senior Dev Wave's Logic) ---
const LEVEL_WEIGHTS = { 'BG': 1, 'N': 2, 'S': 3, 'P': 4 };
const LEVEL_COLORS = {
    'BG': '#bdbdbd', // ‡πÄ‡∏ó‡∏≤ (Beginner)
    'N': '#66bb6a',  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Normal)
    'S': '#ffa726',  // ‡∏™‡πâ‡∏° (Semi-Pro)
    'P': '#ef5350'   // ‡πÅ‡∏î‡∏á (Pro)
};


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡πÄ‡∏ß‡∏• (‡∏ß‡∏ô‡∏•‡∏π‡∏õ BG -> N -> S -> P -> BG)
const toggleLevel = (id) => {
    const p = players.find(x => x.id === id);
    if (!p) return;
   
    const levels = ['BG', 'N', 'S', 'P']; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏¢‡∏®
    const currentIdx = levels.indexOf(p.level || 'BG');
    p.level = levels[(currentIdx + 1) % levels.length]; // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ
   
    updateQueueDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
};


// ==========================================
// ‚öñÔ∏è GOD TIER BALANCING SYSTEM (V.Final)
// ==========================================

const RANK_SCORES = { 'P': 4, 'S': 3, 'N': 2, 'BG': 1 };

// Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Rank + Anti-Streak Weight)
function getPlayerPower(p) {
    const baseScore = RANK_SCORES[p.level || 'BG'] || 1;
    
    // üî• Rule 4: Anti-Streak (The Challenger)
    // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏ô‡∏∞‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 3 ‡∏ï‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏° +0.5
    // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á 
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏Å‡∏ó‡∏µ‡∏°‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ Balance ‡πÄ‡∏õ‡πá‡∏ô 0
    const streakPenalty = (p.winStreak >= 3) ? 0.5 : 0;
    
    return baseScore + streakPenalty;
}

// Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Win Rate (0.0 - 1.0)
function getWinRate(p) {
    return p.gamesPlayed > 0 ? (p.wins / p.gamesPlayed) : 0;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û
const autoBalanceTeam = (candidates) => {
    // ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á (Booking) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤
    if (candidates.some(p => p.bookingId) || candidates.length !== 4) {
        return candidates;
    }

    // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
    // Combo 1: [0,1] vs [2,3]
    // Combo 2: [0,2] vs [1,3]
    // Combo 3: [0,3] vs [1,2]
    const combinations = [
        [0, 1, 2, 3], 
        [0, 2, 1, 3], 
        [0, 3, 1, 2]  
    ];

    let bestCombo = combinations[0];
    let minDiffScore = Infinity; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

    combinations.forEach(combo => {
        const p1 = candidates[combo[0]];
        const p2 = candidates[combo[1]];
        const p3 = candidates[combo[2]];
        const p4 = candidates[combo[3]];

        // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡πâ‡∏≤‡∏° (Constraints) ---
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏´‡∏π (Gap > 2)
        // P(4) ‡∏Ñ‡∏π‡πà BG(1) = ‡∏ï‡πà‡∏≤‡∏á 3 -> ‡∏´‡πâ‡∏≤‡∏°!
        const score1 = RANK_SCORES[p1.level||'BG'];
        const score2 = RANK_SCORES[p2.level||'BG'];
        const score3 = RANK_SCORES[p3.level||'BG'];
        const score4 = RANK_SCORES[p4.level||'BG'];


        // --- 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏• (Primary Goal: Power Balance) ---
        
        const team1Power = getPlayerPower(p1) + getPlayerPower(p2);
        const team2Power = getPlayerPower(p3) + getPlayerPower(p4);
        
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡∏° (‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)
        // ‡∏Ñ‡∏π‡∏ì 1000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Win Rate
        const powerDiff = Math.abs(team1Power - team2Power) * 1000; 

        // --- 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (Secondary Goal: Win Rate Equalizer) ---
        
        const team1WinRate = getWinRate(p1) + getWinRate(p2);
        const team2WinRate = getWinRate(p3) + getWinRate(p4);
        
        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Win Rate (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Tie-breaker)
        const winRateDiff = Math.abs(team1WinRate - team2WinRate);

        // --- 4. ‡∏Å‡∏é‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Optional) ---
        // ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏©‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥ (Partner Repeat) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏ô
        let repeatPenalty = 0;
        if (getPairCount(p1.id, p2.id) > 0) repeatPenalty += 500;
        if (getPairCount(p3.id, p4.id) > 0) repeatPenalty += 500;

        // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏¢‡πà (‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)
        // Score = (‡∏û‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô * 1000) + (‡πÇ‡∏ó‡∏©‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥) + (WinRate ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
        const totalBadness = powerDiff + repeatPenalty + winRateDiff;

        if (totalBadness < minDiffScore) {
            minDiffScore = totalBadness;
            bestCombo = combo;
        }
    });

    // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏° Combo ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    return [
        candidates[bestCombo[0]], 
        candidates[bestCombo[1]], 
        candidates[bestCombo[2]], 
        candidates[bestCombo[3]]
    ];
};




// ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏±‡∏î‡∏Ñ‡∏ô‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ (‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ push)
const addPlayerToCourt = (court, player) => {
    // ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ undefined ‡∏Å‡πà‡∏≠‡∏ô
    let emptyIdx = court.players.findIndex(p => p === null || p === undefined);
   
    if (emptyIdx !== -1) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏´‡∏•‡∏∏‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏•‡∏á‡∏´‡∏•‡∏∏‡∏°
        court.players[emptyIdx] = player;
        const activeCount = court.players.filter(p => p !== null).length;
        if (activeCount === 4) {
            court.gameStartTime = Date.now(); 
        }
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏•‡∏∏‡∏° (‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° 4) ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥
        if (court.players.length < 4) {
            court.players.push(player);
        } else {
            console.error("‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤!");
        }
    }
};


// --- Data ---
let players = [];
let courts = [];  
let courtCount = 2;
let bookingCounter = 0;
let activeGameResolveCourtId = null;
let pairingHistory = {};
let opponentHistory = {}; // ‚ú® NEW: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π
let matchLogs = [];
let isRankedMode = false; // ‚ú® NEW: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Ranked Mode
let completedGameTimes = []; // ‚ú® NEW: ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ)
const DEFAULT_GAME_TIME = 15; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)

// --- Configuration (Frozen Logic V4.0) ---
const AVG_GAME_DURATION = 15;
const AUTO_START_DELAY = 30;


// --- Init ---
function init() {
    renderCourts();
    updateQueueDisplay(); // ‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ updateNextMatchPanel ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏à‡∏ö‡πÄ‡∏•‡∏¢

    updateCustomHoursInputs();
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    if (loadData()) {
        console.log("üìÇ Loaded data from LocalStorage");
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠ (‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ) ‡∏´‡∏£‡∏∑‡∏≠ Reset Timer ‡∏Å‡πá‡πÑ‡∏î‡πâ
        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞ Render ‡πÄ‡∏•‡∏¢
    }


    renderCourts();
    updateQueueDisplay();
   
    // Auto Save Loop (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥)
    setInterval(saveData, 5000);


    // Auto Refresh Logic
    setInterval(() => {
        // ‚ú® FIX UI FREEZE: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏° Auto Fill/Render
        if (!isModalOpen()) {
            autoFillCourts();
        }
    }, 1000);

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å StartTime
    setInterval(() => {
        courts.forEach((c, idx) => {
            if (c.state === 'playing' && c.gameStartTime) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á: (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°) / 1000
                const diffSec = Math.floor((Date.now() - c.gameStartTime) / 1000);
                c.timer = diffSec; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                const el = document.getElementById(`timer-${idx}`);
                if (el) el.innerText = formatTime(diffSec);
            }
        });
    }, 1000);

    setInterval(() => {
        if (!isModalOpen()) {
            updateQueueDisplay();
        }
    }, 60000);
   
    updateCustomHoursInputs();
}


// --- VIEW SWITCHING ---
function toggleView(viewName) {
    document.getElementById('main-view').classList.add('hidden');
    document.getElementById('overview-view').classList.add('hidden');
   
    if(viewName === 'main') {
        document.getElementById('main-view').classList.remove('hidden');
    } else {
        document.getElementById('overview-view').classList.remove('hidden');
        renderOverview();
    }
}

function toggleRankedMode() {
    const checkbox = document.getElementById('ranked-mode-toggle');
    isRankedMode = checkbox.checked;
    
    if (isRankedMode) {
        alert('üèÜ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö! \n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà "‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô" ‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (P ‡πÄ‡∏à‡∏≠ P, BG ‡πÄ‡∏à‡∏≠ BG)');
    } else {
        alert('üëå ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö \n‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö "‡∏Ñ‡∏•‡∏∞‡∏°‡∏∑‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏™‡∏µ)');
    }
    updateNextMatchPanel(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    saveData(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
}

// --- LOGIC: MATCHMAKING ---
function getPairKey(id1, id2) { return id1 < id2 ? `${id1}-${id2}` : `${id2}-${id1}`; }
function recordPairing(id1, id2) {
    const key = getPairKey(id1, id2);
    if (!pairingHistory[key]) pairingHistory[key] = 0;
    pairingHistory[key]++;
}
// ‚ú® ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏™‡πà‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏õ‡∏¥‡∏î } ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
function getPairCount(id1, id2) { return pairingHistory[getPairKey(id1, id2)] || 0; }


// ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥)
function recordOpponent(id1, id2) {
    const key = getPairKey(id1, id2);
    if (!opponentHistory[key]) opponentHistory[key] = 0;
    opponentHistory[key]++;
}


function getOpponentCount(id1, id2) {
    return opponentHistory[getPairKey(id1, id2)] || 0;
}
function addPlayers() {
    const input = document.getElementById('new-players');
    const rawText = input.value.trim();
    if (!rawText) return;
    const names = rawText.split('\n').map(n => n.trim()).filter(n => n);
    let maxGamesInSystem = 0;
    players.forEach(p => { if(p.gamesPlayed > maxGamesInSystem) maxGamesInSystem = p.gamesPlayed; });


    names.forEach(name => {
        let cleanName = name.replace(/^[\d]+\.[\s]*/, '');
        let joinTime = Date.now();
        let isFastPass = false;
        if (maxGamesInSystem > 2) {
            joinTime = Date.now() - (60 * 60 * 1000);
            isFastPass = true;
        }
        players.push({
            id: Date.now() + Math.random(),
            name: cleanName,
            level: 'BG', // ‚ú®
            gamesPlayed: 0,
            wins: 0,
            status: 'waiting',
            joinedQueueAt: joinTime,
            bookingId: null,
            winStreak: 0, // ‚ú® NEW: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 0
            sessionGames: 0,
            isFastPass: isFastPass,
            checkInTime: new Date(),
            isResting: false // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        });
    });
    input.value = '';
    updateQueueDisplay();
    saveData();
}


const removePlayer = (id) => {
    const p = players.find(x => x.id === id);
    if (!p) return;


    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö
    if(p.status === 'playing') { alert('‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö'); return; }


    // ‚ú® NEW: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ö‡∏±‡πä‡∏Å
    if (p.bookingId) {
        const others = players.filter(x => x.bookingId === p.bookingId && x.id !== id);
        if (others.length > 0) {
            if(!confirm(`‚ö†Ô∏è ${p.name} ‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö (${others.map(o=>o.name).join(', ')}) \n‡∏ñ‡πâ‡∏≤‡∏•‡∏ö Booking ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏´‡∏°?`)) return;
           
            // ‡∏•‡πâ‡∏≤‡∏á Booking ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏™‡∏î)
            players.forEach(x => {
                if(x.bookingId === p.bookingId) {
                    x.bookingId = null;
                    x.bookingTeam = null;
                }
            });
        }
    } else {
        if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${p.name} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;
    }


    // ‡∏•‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå
    players = players.filter(p => p.id !== id);
    updateQueueDisplay();
    saveData();
};




function resetStatsOnly() {
    if(!confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?')) return;
    players.forEach(p => {
        p.gamesPlayed = 0; p.wins = 0; p.sessionGames = 0;
        p.status = 'waiting'; p.joinedQueueAt = Date.now(); p.bookingId = null; p.isFastPass = false;
    });
    pairingHistory = {};
    opponentHistory = {}; // ‚ú® NEW: ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏±‡∏ï‡∏£‡∏π
    matchLogs = [];
    renderMatchLog();
    resetCourtsState();
    updateQueueDisplay();
}


function resetAll() {
    if(!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô, ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á!)')) return;
    if(!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞ ‡πÄ‡∏≠‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥?')) return;


    players = [];
    pairingHistory = {};
    opponentHistory = {};
    matchLogs = [];
    courts.forEach(c => {
        clearInterval(c.interval);
        c.players = [];
        c.state = 'empty';
        c.timer = 0;
    });
   
    localStorage.removeItem(STORAGE_KEY); // ‚ú® ‡∏•‡πâ‡∏≤‡∏á LocalStorage
   
    renderMatchLog();
    renderCourts();
    updateQueueDisplay();
}


function resetCourtsState() {
    courts.forEach(c => {
        clearInterval(c.interval);
        c.players = []; c.state = 'empty'; c.timer = 0; c.isOpened = false; c.autoStartTarget = null;
    });
    renderCourts();
}


function updateCourts(change) {
    const newCount = courtCount + change;
    if (newCount < 1) return;
    courtCount = newCount;
    document.getElementById('court-count').innerText = courtCount;
    document.getElementById('calc-court-count').value = courtCount;
    updateCustomHoursInputs();
    renderCourts();
}

function setCourtRule(courtIdx, newRule) {
    courts[courtIdx].rule = newRule;
    renderCourts();
    updateQueueDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢
    saveData();
}

function renderCourts() {
    const container = document.getElementById('courts-container');
   
    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    if (courts.length < courtCount) {
        for (let i = courts.length; i < courtCount; i++) {
            // ‚ú® Default Rule = 'normal' (‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î)
            courts.push({ id: i, players: [], state: 'empty', timer: 0, interval: null, isOpened: false, autoStartTarget: null, rule: 'normal' });
        }
    } else if (courts.length > courtCount) {
        const removed = courts.pop();
        if (removed.players.length > 0) {
            removed.players.forEach(p => {
                const pl = players.find(x => x.id === p.id);
                if(pl) { pl.status = 'waiting'; pl.joinedQueueAt = Date.now(); pl.sessionGames = 0; }
            });
        }
    }
   
    container.innerHTML = '';
   
    courts.forEach((court, index) => {
        // ‚ú® ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ rule ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà default
        if (!court.rule) court.rule = 'normal';

        let overlayHTML = '';
        if (court.state === 'post_game') {
            overlayHTML = `
                <div class="court-overlay">
                    <button class="btn-overlay btn-call" onclick="triggerFill(${index})">üì¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á</button>
                    <button class="btn-overlay btn-rest" onclick="closeAndRest(${index})">üî¥ ‡∏û‡∏±‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</button>
                </div>
            `;
        } else if (!court.isOpened) {
            overlayHTML = `
                <div class="court-overlay">
                    <button class="btn-overlay btn-open" onclick="openCourt(${index})">üîî ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°</button>
                </div>
            `;
        }
       
        const displayName = court.customName || `#${index + 1}`;

        // ‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î
        const ruleSelectHTML = `
            <select class="court-rule-select" onchange="setCourtRule(${index}, this.value)" onclick="event.stopPropagation()">
                <option value="normal" ${court.rule === 'normal' ? 'selected' : ''}>‚õî ‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î</option>
                <option value="winner_stay" ${court.rule === 'winner_stay' ? 'selected' : ''}>üëë ‡∏Ñ‡∏£‡∏ö 2 ‡πÄ‡∏î‡πâ‡∏á</option>
            </select>
        `;

        const courtHTML = `
            <div class="court" id="court-${index}">
                <div class="court-lines"></div>
                <div class="service-line-top"></div>
                <div class="service-line-bottom"></div>
               
                <div class="court-header" style="position: relative; z-index: 10;">
                    <span onclick="editCourtName(${index})" style="cursor:pointer; display:flex; align-items:center; gap:5px;" title="‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">
                        ${displayName} <span style="font-size:0.8em; opacity:0.6;">‚úèÔ∏è</span>
                    </span>
                    ${ruleSelectHTML}
                </div>
               
                ${overlayHTML}
               
                <div class="court-players">
                    <div class="team team-pink">${renderPlayerOnCourt(court.players[0], index, 0)}${renderPlayerOnCourt(court.players[1], index, 1)}</div>
                    <div class="team team-blue">${renderPlayerOnCourt(court.players[2], index, 2)}${renderPlayerOnCourt(court.players[3], index, 3)}</div>
                </div>
                <div class="court-controls">
                    <div class="timer" id="timer-${index}">${formatTime(court.timer)}</div>
                    ${renderCourtButtons(court, index)}
                </div>
            </div>
        `;
        container.innerHTML += courtHTML;
    });
    updateQueueDisplay();
    updateDashboard();
}


function openCourt(idx) { courts[idx].isOpened = true; renderCourts(); }
function triggerFill(idx) { courts[idx].state = 'empty'; renderCourts(); }
function closeAndRest(idx) {
    courts[idx].players.forEach(p => sendToQueue(p.id));
    courts[idx].players = []; courts[idx].state = 'empty'; courts[idx].isOpened = false; courts[idx].timer = 0;
    renderCourts();
}
function getRuleLabel() { return document.getElementById('game-rule').value === 'winner_stay' ? "Fixed Quota" : ""; }

// ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPlayerOnCourt
function renderPlayerOnCourt(player, courtIdx, slotIdx) {
    if (!player) {
        return `<div class="player-on-court" style="cursor:pointer; opacity:0.7; background:#f0f0f0; color:#888; border:2px dashed #ccc;" onclick="openManualAddModal(${courtIdx})" title="‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á">
            + ‡∏ß‡πà‡∏≤‡∏á
        </div>`;
    }
    
    // ‚ú® ‡∏≠‡πà‡∏≤‡∏ô Rule ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const rule = courts[courtIdx].rule || 'normal';
    
    let badge = (rule === 'winner_stay') ? `<span class="quota-badge" style="background:${player.sessionGames >= 1 ? '#e67e22' : '#27ae60'}">G: ${player.sessionGames + 1}/2</span>` : '';
    
    return `<div class="player-on-court" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß" onclick="kickPlayer(${courtIdx}, ${slotIdx})"><strong>${player.name}</strong><span style="font-size:0.8em; margin-top:2px;">(${player.gamesPlayed}P)</span>${badge}</div>`;
}

function renderCourtButtons(court, idx) {
    if (!court.isOpened || court.state === 'post_game') return `<button class="secondary" style="width:100%;" disabled>...</button>`;
   
    if (court.state === 'playing') return `<button class="danger" style="width:100%;" onclick="stopGame(${idx})">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>`;


    // ‚ú® ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ countRealPlayers ‡πÅ‡∏ó‡∏ô .length
    const realCount = countRealPlayers(court);


    if (realCount === 4) {
        if (court.autoStartTarget) {
            const remaining = Math.ceil((court.autoStartTarget - Date.now()) / 1000);
            if (remaining > 0) return `<button class="success btn-auto-start" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${remaining}s)</button>`;
        }
        return `<button class="success" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>`;
    }
   
    // ... (‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏õ‡πä‡∏∞‡πÜ) ...
    const waiting = players.filter(p => p.status === 'waiting').sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);
    const head = waiting.length > 0 ? waiting[0] : null;
    // ‡πÉ‡∏ä‡πâ realCount ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
    const needed = 4 - realCount;


    // ... (Logic ‡∏õ‡∏∏‡πà‡∏° Booking ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
    let isBookingPair = false;
    let isBookingFour = false;
    let bookingSize = 0;


    if (head && head.bookingId) {
        const group = players.filter(p => p.bookingId === head.bookingId && p.status === 'waiting');
        bookingSize = group.length;


        if (bookingSize <= needed) {
            if (bookingSize === 2) isBookingPair = true;
            if (bookingSize === 4) isBookingFour = true;
        }
    }


    const disabledStyle = "background:#e0e0e0; color:#a0a0a0; cursor:not-allowed; border:1px solid #ccc;";
    const activePairStyle = "background:#9b59b6; color:white;";
    const activeFourStyle = "background:#8e44ad; color:white;";


    return `
        <div style="display:flex; flex-direction:column; gap:4px;">
            <div style="display:flex; gap:4px;">
                <button class="warning" style="flex:1;" onclick="fillCourtSmart(${idx})">üé≤ ‡∏™‡∏∏‡πà‡∏°</button>
                <button style="background:#3498db; color:white; flex:1;" onclick="fillCourtQueue(${idx})">‚è© ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß</button>
            </div>
            <div style="display:flex; gap:4px;">
                <button style="flex:1; ${isBookingPair ? activePairStyle : disabledStyle}"
                    ${isBookingPair ? `onclick="fillCourtSmart(${idx})"` : 'disabled'}>
                    üë• ‡∏à‡∏≠‡∏á‡∏Ñ‡∏π‡πà ${isBookingPair ? '‚úÖ' : ''}
                </button>
                <button style="flex:1; ${isBookingFour ? activeFourStyle : disabledStyle}"
                    ${isBookingFour ? `onclick="fillCourtSmart(${idx})"` : 'disabled'}>
                    ‚öîÔ∏è ‡∏à‡∏≠‡∏á 4 ${isBookingFour ? '‚úÖ' : ''}
                </button>
            </div>
        </div>
    `;
}


// --- üß† SMART AUTO FILL (V5.1 Wave's Logic) ---
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏Ñ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
const autoFillCourts = () => {
    courts.forEach((court, idx) => {
        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•
        if (!court.isOpened || court.state === 'playing' || court.state === 'post_game') return;


        // --- ‚ùå LOGIC ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ---


        // ‚úÖ LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö 4 ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)
        if (countRealPlayers(court) === 4) {
            if (!court.autoStartTarget) {
                court.autoStartTarget = Date.now() + (AUTO_START_DELAY * 1000);
                renderCourts();
            }
            else if (Date.now() >= court.autoStartTarget) {
                startGame(idx);
            }
            else {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Real-time
                const btn = document.querySelector(`#court-${idx} .btn-auto-start`);
                if (btn) btn.innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${Math.ceil((court.autoStartTarget - Date.now()) / 1000)}s)`;
            }
        } else {
             // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å) ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
             court.autoStartTarget = null;
        }
    });
};


// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ fillCourtSmart ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
const fillCourtSmart = (courtIdx) => {
    const court = courts[courtIdx];
    const existingPlayers = court.players.filter(p => p !== null && p !== undefined);
    const needed = 4 - existingPlayers.length;

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Skip (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const waiting = players.filter(p => p.status === 'waiting' && !p.isResting && !p.bookingId)
                           .sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);
    const headOfQueue = waiting.length > 0 ? waiting[0] : null;

    // üîç ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î (Strict Mode)
    let candidates = getSmartDraft(needed, new Set(), existingPlayers, false); // false = ‡πÑ‡∏°‡πà Force

    // ‚ö†Ô∏è ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏´‡∏¢‡∏ß‡∏ô‡πÜ (Force Mode)
    if (candidates.length === 0 && waiting.length >= needed) {
        console.log("‚ö†Ô∏è ‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏™‡πÄ‡∏õ‡∏Ñ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏¢‡∏ß‡∏ô‡πÜ (Force Mode)");
        candidates = getSmartDraft(needed, new Set(), existingPlayers, true); // true = Force
    }
   
    if (candidates.length > 0) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ Skip Count
        if (headOfQueue) {
            const isHeadPicked = candidates.some(c => c.id === headOfQueue.id);
            if (!isHeadPicked) {
                headOfQueue.skipCount = (headOfQueue.skipCount || 0) + 1;
            } else {
                headOfQueue.skipCount = 0;
            }
        }

        candidates.forEach(p => {
            p.status = 'playing';
            p.sessionGames = 0;
            if(p.isFastPass) p.isFastPass = false;
            p.bookingId = null;
            p.bookingTeam = null;
            addPlayerToCourt(court, p);
        });
        renderCourts();
    } else {
        // ‡∏ñ‡πâ‡∏≤ Force ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 4 ‡∏Ñ‡∏ô)
        alert('‚ùå ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ' + needed + ' ‡∏Ñ‡∏ô)');
    }
    saveData();
};


// ‡∏õ‡∏∏‡πà‡∏° 2: ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß (Queue Fill)
const fillCourtQueue = (courtIdx) => {
    const court = courts[courtIdx];


    // üî¥ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ countRealPlayers ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
    const needed = 4 - countRealPlayers(court);
   
    const waiting = players
        .filter(p => p.status === 'waiting'&& !p.isResting)
        .sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);


    if (waiting.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö'); return; }


    const firstP = waiting[0];
    let candidates = [];


    // üõ°Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å "‡∏°‡∏µ Booking"
    if (firstP.bookingId) {
        const group = waiting.filter(p => p.bookingId === firstP.bookingId);
        group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));


        if (group.length > needed) {
            alert(`‚ö†Ô∏è ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ! ‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠ Booking (${group.length} ‡∏Ñ‡∏ô) ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà ${needed} ‡∏ó‡∏µ‡πà`);
            return;
        }
        candidates = group;
    }
    // üõ°Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏°‡∏≤‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
    else {
        for (let i = 0; i < waiting.length; i++) {
            if (candidates.length >= needed) break;
            const p = waiting[i];
            if (p.bookingId) break;
            candidates.push(p);
        }
    }


    if (candidates.length > 0) {
      // ‚ú® NEW: ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡∏°‡∏Å‡πà‡∏≠‡∏ô
        if (candidates.length === 4) {
            candidates = autoBalanceTeam(candidates);
        }
        candidates.forEach(p => {
            p.status = 'playing';
            p.sessionGames = 0;
            if(p.isFastPass) p.isFastPass = false;
            // ‡πÉ‡∏ä‡πâ addPlayerToCourt ‡∏¢‡∏±‡∏î‡∏•‡∏á‡∏£‡∏π
            addPlayerToCourt(court, p);
        });
        renderCourts();
    }
};
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á)
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° excludeIds (Set) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Simulation ‡πÑ‡∏î‡πâ
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: getSmartDraft ‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Auto Balance
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° (Smart Draft)
// ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö parameter ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡πÄ‡∏ä‡πá‡∏Ñ Rank
// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ getSmartDraft ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
// ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö isForce (‡∏Ñ‡πà‡∏≤ Default = false)
function getSmartDraft(count, excludeIds = new Set(), existingPlayers = [], isForce = false) {
    let pool = players.filter(p => p.status === 'waiting' && !p.isResting && !excludeIds.has(p.id));
    pool.sort((a, b) => a.joinedQueueAt - b.joinedQueueAt); 

    if (pool.length === 0) return [];

    // ‚ú® ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let targetScore = null;
    if (existingPlayers.length > 0) {
        targetScore = existingPlayers.reduce((sum, p) => sum + (RANK_SCORES[p.level||'BG']||1), 0);
    }

    // Pity Logic (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏≤‡∏£)
    const head = pool[0];
    if (head && head.skipCount > 0 && !isForce) {
        let team = tryBuildTeam(head, pool, count, existingPlayers, true, targetScore, false);
        if (team.length === count) return team; 
    }

    // Normal & Force Logic
    for (let i = 0; i < pool.length; i++) {
        let captain = pool[i];
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Force -> ‡πÄ‡∏ä‡πá‡∏Ñ Rank ‡∏Å‡∏±‡∏õ‡∏ï‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        if (!isForce && isRankedMode && existingPlayers.length > 0) {
             const capScore = RANK_SCORES[captain.level || 'BG'] || 1;
             let isCompatible = true;
             for(let ex of existingPlayers) {
                 const exScore = RANK_SCORES[ex.level || 'BG'] || 1;
                 if (Math.abs(capScore - exScore) >= 2) { isCompatible = false; break; }
             }
             if (!isCompatible) continue; 
        }
        
        // ‚ú® ‡∏™‡πà‡∏á targetScore ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡πâ tryBuildTeam ‡∏î‡πâ‡∏ß‡∏¢ (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Force Mode ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ!)
        let team = tryBuildTeam(captain, pool, count, existingPlayers, false, targetScore, isForce); 
        
        if (team.length === count) {
            if (count === 4 && !isForce) return autoBalanceTeam(team);
            return team;
        }
    }
    
    return [];
}

// ‚ú® Helper Function ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á Rank (‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ getSmartDraft ‡∏Å‡πá‡πÑ‡∏î‡πâ)
function isRankCompatible(player, targetPlayers) {
    const pScore = RANK_SCORES[player.level || 'BG'] || 1;
    for (let target of targetPlayers) {
        const tScore = RANK_SCORES[target.level || 'BG'] || 1;
        // ‡∏ñ‡πâ‡∏≤‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô BG ‡πÄ‡∏à‡∏≠ S) ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
        if (Math.abs(pScore - tScore) >= 2) return false; 
    }
    return true;
}

// ‚ú® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° (‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏¢‡∏¥‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
// ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö parameter ‡πÄ‡∏û‡∏¥‡πà‡∏°: isPity, targetScore
// ‡∏£‡∏±‡∏ö parameter isForce ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
function tryBuildTeam(captain, currentPool, targetCount, existingPlayers = [], isPity = false, targetScore = null, isForce = false) {
    let selected = [];
    let usedIds = new Set();

    if (captain.bookingId) {
        const group = currentPool.filter(x => x.bookingId === captain.bookingId);
        if (group.length > targetCount) return [];
        group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));
        group.forEach(p => { selected.push(p); usedIds.add(p.id); });
    } else {
        selected.push(captain);
        usedIds.add(captain.id);
    }

    while (selected.length < targetCount) {
        let nextPlayer = null;
       
        if (selected.length % 2 !== 0 && !selected[selected.length-1].bookingId) {
            let currentSolo = selected[selected.length - 1];
            // ‚ú® ‡∏™‡πà‡∏á isForce ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            nextPlayer = findBestPartnerInfinite(currentSolo, currentPool, usedIds, existingPlayers, isPity, targetScore, isForce);
        } 
        else {
            const effectiveTeam = [...selected, ...existingPlayers];
            nextPlayer = findBestOpponentInfinite(effectiveTeam, currentPool, usedIds);
        }

        if (nextPlayer) {
            selected.push(nextPlayer);
            usedIds.add(nextPlayer.id);
        } else {
            break; 
        }
    }
    return selected;
}

// ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏´‡∏π ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö rankCheckList (‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏™‡∏ô‡∏≤‡∏°)
// ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö isPity, targetScore
function findBestPartnerInfinite(captain, fullPool, usedIds, rankCheckList = [], isPity = false, targetScore = null, isForce = false) {
    let best = null;
    let minScore = Infinity;
    
    const capScore = RANK_SCORES[captain.level || 'BG'] || 1;
   
    for (let i = 0; i < fullPool.length; i++) {
        const c = fullPool[i];
        if (c.id === captain.id || usedIds.has(c.id) || c.bookingId) continue;
       
        let finalScore = 0;

        // üî• ‡∏Å‡∏£‡∏ì‡∏µ FORCE MODE: ‡∏™‡∏π‡∏ï‡∏£ "‡∏´‡∏¢‡∏ß‡∏ô‡πÜ ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏™‡∏°‡∏≠‡∏á"
        if (isForce) {
            // 1. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏¥‡∏ß (Queue Cost): ‡∏¢‡∏¥‡πà‡∏á‡∏£‡∏≠‡∏ô‡∏≤‡∏ô (i ‡∏ô‡πâ‡∏≠‡∏¢) ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ
            // ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞ 1000 ‡πÅ‡∏ï‡πâ‡∏°
            // (‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡πÇ‡∏î‡∏ô‡∏ö‡∏ß‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
            const queueCost = i * 1000; 

            // 2. ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏• (Balance Cost): ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏µ‡∏° ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á
            let balanceCost = 0;
            if (targetScore !== null) {
                const myTeamScore = capScore + (RANK_SCORES[c.level||'BG']||1);
                const diff = Math.abs(myTeamScore - targetScore);
                // ‡∏¢‡∏≠‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ 2-3 ‡∏Ñ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö Balance ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏Ç‡∏±‡πâ‡∏ô
                // 1 Level Gap = 2500 ‡πÅ‡∏ï‡πâ‡∏°
                balanceCost = diff * 2500; 
            }

            // 3. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥ (Pair Cost): ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà
            const pairCount = getPairCount(captain.id, c.id);
            const pairCost = pairCount * 3000; 

            finalScore = queueCost + balanceCost + pairCost;
        }
        // üõ°Ô∏è ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ / Pity (Logic ‡πÄ‡∏î‡∏¥‡∏°)
        else {
            if (isPity && targetScore !== null) {
                 const cScore = RANK_SCORES[c.level || 'BG'] || 1;
                 const ourTeamSum = capScore + cScore;
                 const diff = Math.abs(ourTeamSum - targetScore);
                 // Pity ‡πÄ‡∏ô‡πâ‡∏ô Balance ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
                 finalScore = (getPairCount(captain.id, c.id) * 1000000) + (diff * 1000) + i;
            } else {
                // Strict Mode
                const pairPenalty = (getPairCount(captain.id, c.id) >= 2) ? 999999999 : getPairCount(captain.id, c.id) * 1000000;
                let rankPenalty = 0;
                if (isRankedMode) {
                    const cScore = RANK_SCORES[c.level || 'BG'] || 1;
                    const diffCap = Math.abs(capScore - cScore);
                    if (diffCap === 1) rankPenalty += 5000000;
                    if (diffCap >= 2) rankPenalty += 500000000;

                    for(let existing of rankCheckList) {
                        const exScore = RANK_SCORES[existing.level || 'BG'] || 1;
                        const diffEx = Math.abs(cScore - exScore);
                        if (diffEx === 1) rankPenalty += 5000000;
                        else if (diffEx >= 2) rankPenalty += 500000000;
                    }
                }
                finalScore = pairPenalty + rankPenalty + i;
            }
        }
       
        if (finalScore < minScore) {
            minScore = finalScore;
            best = c;
        }
    }
    return best;
}





// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ
function findBestOpponentInfinite(currentTeam, fullPool, usedIds) {
    let best = null;
    let minScore = Infinity;
   
    for (let i = 0; i < fullPool.length; i++) {
        const c = fullPool[i];
       
        if (usedIds.has(c.id) || c.bookingId) continue;
       
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏´‡∏ô‡πâ‡∏≤‡∏ã‡πâ‡∏≥"
        let conflictScore = 0;
        currentTeam.forEach(member => {
            const opCount = getOpponentCount(member.id, c.id);
            conflictScore += (opCount >= 2) ? 100000000 : (opCount * 1000000);
        });

        // ‚ú® RANKED LOGIC: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏®‡∏±‡∏ï‡∏£‡∏π" ‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ö "‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏≤" ‡πÑ‡∏´‡∏°
        let rankPenalty = 0;
        if (isRankedMode) {
            const cScore = RANK_SCORES[c.level || 'BG'] || 1;
            
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            let maxDiff = 0;
            currentTeam.forEach(member => {
                const mScore = RANK_SCORES[member.level || 'BG'] || 1;
                const diff = Math.abs(mScore - cScore);
                if (diff > maxDiff) maxDiff = diff;
            });

            // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏Ñ‡∏ô‡∏¢‡∏®‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏•‡∏á‡πÇ‡∏ó‡∏©‡∏´‡∏ô‡∏±‡∏Å‡πÜ
            if (maxDiff === 1) rankPenalty = 5000000;
            else if (maxDiff >= 2) rankPenalty = 500000000;
        }

        const totalScore = conflictScore + rankPenalty + i;
       
        if (totalScore < minScore) {
            minScore = totalScore;
            best = c;
        }
    }
    return best;
}

function startGame(courtIdx) {
    const court = courts[courtIdx];
    court.state = 'playing';
    court.gameStartTime = Date.now(); // ‚úÖ ‡∏à‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
    court.timer = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏ß‡πå
    court.autoStartTarget = null;
   
    // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡πà‡∏´‡∏π (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    if(court.players[0] && court.players[1]) recordPairing(court.players[0].id, court.players[1].id);
    if(court.players[2] && court.players[3]) recordPairing(court.players[2].id, court.players[3].id);

    // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const p0 = court.players[0]; const p1 = court.players[1];
    const p2 = court.players[2]; const p3 = court.players[3];
    if (p0 && p2) recordOpponent(p0.id, p2.id);
    if (p0 && p3) recordOpponent(p0.id, p3.id);
    if (p1 && p2) recordOpponent(p1.id, p2.id);
    if (p1 && p3) recordOpponent(p1.id, p3.id);

    renderCourts();
    saveData();
}


function stopGame(courtIdx) {
    const court = courts[courtIdx]; clearInterval(court.interval);
    court.players.forEach(p => { const pl = players.find(x => x.id === p.id); if(pl) { pl.gamesPlayed++; pl.sessionGames++; } });
    activeGameResolveCourtId = courtIdx; document.getElementById('winner-modal').style.display = 'flex';
}


function cancelStopGame() {
    const court = courts[activeGameResolveCourtId];
    court.players.forEach(p => { const pl = players.find(x => x.id === p.id); if(pl) { pl.gamesPlayed--; pl.sessionGames--; } });
    court.interval = setInterval(() => { court.timer++; document.getElementById(`timer-${activeGameResolveCourtId}`).innerText = formatTime(court.timer); }, 1000);
    document.getElementById('winner-modal').style.display = 'none'; activeGameResolveCourtId = null; renderCourts();
}


function resolveGame(winningTeamIdx) {
    const court = courts[activeGameResolveCourtId];
    document.getElementById('winner-modal').style.display = 'none';


    // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Å‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞/‡πÅ‡∏û‡πâ) -> ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
    if (winningTeamIdx === -1) {
        court.players.forEach(p => sendToQueue(p.id));
        court.players = [];
        court.state = 'post_game';
    }
    // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏°‡∏µ‡πÅ‡∏û‡πâ/‡∏ä‡∏ô‡∏∞
    else {
        const t1 = [court.players[0], court.players[1]];
        const t2 = [court.players[2], court.players[3]];
       
        let winners = (winningTeamIdx === 0) ? t1 : t2;
        let losers = (winningTeamIdx === 0) ? t2 : t1;
       
       // ‚ú® 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ "‡∏Å‡πà‡∏≠‡∏ô"
        if (court.gameStartTime) {
            const durationMs = Date.now() - court.gameStartTime;
            const durationMins = Math.round(durationMs / 60000); 

            // ‡∏Å‡∏£‡∏≠‡∏á Error: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ô‡∏±‡∏ö
            if (durationMins >= 2) {
                completedGameTimes.push(durationMins);
                if (completedGameTimes.length > 5) completedGameTimes.shift(); 
            }
            // court.gameStartTime = null; // ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
        matchLogs.unshift({
            time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
            court: activeGameResolveCourtId+1,
            winners: winners.map(p=>p.name).join(', '),
            losers: losers.map(p=>p.name).join(', '),
            duration: formatTime(court.timer),
        });
        court.gameStartTime = null; 
        renderMatchLog();
       
        // ‡∏ö‡∏ß‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏ô‡∏∞
        winners.forEach(p => {
            const pl = players.find(x => x.id === p.id);
            if(pl) pl.wins++;
            pl.winStreak = (pl.winStreak || 0) + 1; // ‚ú® ‡∏ö‡∏ß‡∏Å‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ
        });
        losers.forEach(p => {
            const pl = players.find(x => x.id === p.id);
            if(pl) {
                pl.winStreak = 0; // ‚ú® ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ
            }
        });


        let stayers = [], leavers = [];
       
        // ‚ú® NEW: ‡∏î‡∏∂‡∏á‡∏Å‡∏é‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        const rule = court.rule || 'normal';

        if (rule === 'normal') {
            // ‡πÇ‡∏´‡∏°‡∏î Normal: ‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            leavers.push(...t1, ...t2);
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î Fixed Quota (Winner Stay ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ 2 ‡πÄ‡∏Å‡∏°)
            const q1 = players.find(x => x.id === t1[0].id).sessionGames;
            const q2 = players.find(x => x.id === t2[0].id).sessionGames;

            if (q1 < 2 && q2 < 2) {
                // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà -> ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠, ‡∏ú‡∏π‡πâ‡πÅ‡∏û‡πâ‡∏≠‡∏≠‡∏Å
                if (winningTeamIdx === 0) { stayers.push(...t1); leavers.push(...t2); }
                else { stayers.push(...t2); leavers.push(...t1); }
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (‡∏Ñ‡∏£‡∏ö 2 ‡πÄ‡∏Å‡∏°) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞)
                if (q1 >= 2) leavers.push(...t1); else stayers.push(...t1);
                if (q2 >= 2) leavers.push(...t2); else stayers.push(...t2);
            }
        }
       
        // ‡∏™‡∏±‡πà‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ô
        leavers.forEach(p => sendToQueue(p.id));
        court.players = [...stayers];
        court.state = 'post_game';
    }
    court.timer = 0;
    renderCourts();
    saveData();
}


function sendToQueue(playerId) { 
  const pl = players.find(x => x.id === playerId);
   if(pl) { 
        pl.status = 'waiting'; 
        pl.joinedQueueAt = Date.now(); 
        pl.sessionGames = 0; 
    } }
// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Modern Syntax (Arrow Function)
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö "‡πÄ‡∏à‡∏≤‡∏∞‡∏£‡∏π" (Fixed Slot) ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
const kickPlayer = (courtIdx, slotIdx) => {
    const court = courts[courtIdx];
    const player = court.players[slotIdx];


    if (!player) return; // ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏à‡∏ö
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß ${player.name} ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;


    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß
    sendToQueue(player.id);
   
    // 2. ‚ú® ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô null ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ splice
    court.players[slotIdx] = null;
   
    // 3. ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà
    if (court.state === 'playing') {
        clearInterval(court.interval);
        court.state = 'empty';
        console.log(`Game paused at ${court.timer}s`);
    }
   
    court.autoStartTarget = null;
    renderCourts();
};
// --- UI HELPERS ---
function renderMatchLog() {
    const tbody = document.getElementById('match-log-body');
    if (matchLogs.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:gray;">-</td></tr>'; return; }
    tbody.innerHTML = matchLogs.map(log => `<tr><td>${log.time}</td><td>${log.court}</td><td class="log-winner">${log.winners}</td><td class="log-loser">${log.losers}</td><td>${log.duration}</td></tr>`).join('');
}


function updateDashboard() {
    const tbody = document.getElementById('stats-body');
    const sortType = document.getElementById('sort-select').value;
   
    let sorted = [...players].sort((a, b) => {
        if (sortType === 'games_desc') return b.gamesPlayed - a.gamesPlayed;
        if (sortType === 'games_asc') return a.gamesPlayed - b.gamesPlayed;
        if (sortType === 'wins_desc') return b.wins - a.wins;
        return 0;
    });


    tbody.innerHTML = sorted.map((p, index) => {
        let rank = index + 1;
        let medal = '';
        if (rank === 1) medal = 'ü•á'; else if (rank === 2) medal = 'ü•à'; else if (rank === 3) medal = 'ü•â';
        const rate = p.gamesPlayed > 0 ? Math.round((p.wins / p.gamesPlayed) * 100) : 0;
        return `<tr><td>${medal} ${rank}</td><td>${p.name}</td><td>${p.gamesPlayed}</td><td>${p.wins}</td><td>${rate}%</td></tr>`;
    }).join('');
}


// --- OVERVIEW & COST ---
function renderOverview() {
    const statsBody = document.getElementById('overview-stats-body');
    const repeatBody = document.getElementById('overview-repeat-body');
   
    statsBody.innerHTML = players.map(p => {
        let time = p.checkInTime ? new Date(p.checkInTime).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-';
        return `<tr><td style="text-align:left">${p.name}</td><td>${time}</td><td>${p.gamesPlayed}</td><td>${p.wins}</td></tr>`;
    }).join('');


    let repeats = [];
    for (const [key, count] of Object.entries(pairingHistory)) {
        if (count > 1) {
            const [id1, id2] = key.split('-');
            const p1 = players.find(p => p.id == id1); const p2 = players.find(p => p.id == id2);
            if (p1 && p2) repeats.push({ name: `${p1.name} + ${p2.name}`, count: count });
        }
    }
    repeats.sort((a, b) => b.count - a.count);
    repeatBody.innerHTML = repeats.length === 0 ? '<tr><td colspan="2" style="color:green;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥</td></tr>' : repeats.map(s => `<tr><td style="text-align:left;">${s.name}</td><td style="color:#e65100; font-weight:bold;">${s.count}</td></tr>`).join('');


    updateCost();
}


let isCustomHours = false;
function toggleCustomHours() {
    isCustomHours = !isCustomHours;
    document.getElementById('custom-hours-area').style.display = isCustomHours ? 'block' : 'none';
    document.getElementById('std-hours-group').style.display = isCustomHours ? 'none' : 'flex';
    updateCustomHoursInputs();
    updateCost();
}


function updateCustomHoursInputs() {
    const area = document.getElementById('custom-hours-area');
    area.innerHTML = '';
    for(let i=0; i<courtCount; i++) {
        area.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label>‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${i+1}:</label><input type="number" class="court-hr-input" value="2" style="width:50px;" onchange="updateCost()"> ‡∏ä‡∏°.</div>`;
    }
}


// ==========================================
// üí∞ LOGIC ‡∏´‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏ü‡∏£‡πå‡πÜ (Time-based)
// ==========================================


function updateCost() {
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Grand Total) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞
    const pricePerHr = parseFloat(document.getElementById('calc-court-price').value) || 0;
    let totalHours = 0;


    if (isCustomHours) {
        document.querySelectorAll('.court-hr-input').forEach(inp => totalHours += parseFloat(inp.value) || 0);
    } else {
        totalHours = (parseFloat(document.getElementById('calc-hours').value) || 0) * (parseFloat(document.getElementById('calc-court-count').value) || 0);
    }


    const shuttlePrice = parseFloat(document.getElementById('calc-shuttle-price').value) || 0;
    const shuttleUsed = parseFloat(document.getElementById('calc-shuttle-used').value) || 0;
    const shuttleTotal = (shuttlePrice / 12) * shuttleUsed;


    const grandTotal = (totalHours * pricePerHr) + shuttleTotal;
   
    // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    document.getElementById('total-cost-display').innerText = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});


    // 2. --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô ---
    const now = new Date();
    let totalMinutesAllPlayers = 0;


    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ)
    players.forEach(p => {
        if (p.checkInTime) {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Check-in ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ)
            const diffMs = now - new Date(p.checkInTime);
            p.minutesPresent = Math.max(1, Math.floor(diffMs / 60000)); // ‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ô‡∏≤‡∏ó‡∏µ
        } else {
            p.minutesPresent = 0;
        }
        totalMinutesAllPlayers += p.minutesPresent;
    });


    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡πÑ‡∏ï‡∏£‡∏¢‡∏≤‡∏á‡∏®‡πå (‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏π / ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) * ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°
    players.forEach(p => {
        if (totalMinutesAllPlayers > 0 && grandTotal > 0) {
            p.calculatedCost = (p.minutesPresent / totalMinutesAllPlayers) * grandTotal;
        } else {
            p.calculatedCost = 0;
        }
    });


    // 3. ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏™‡πà‡∏á true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateCost ‡∏ã‡πâ‡∏≥)
    renderOverview(true);
}


function renderOverview(skipUpdateCost = false) {
    const statsBody = document.getElementById('overview-stats-body');
    const repeatBody = document.getElementById('overview-repeat-body');
   
    // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
    statsBody.innerHTML = players.map(p => {
        let time = p.checkInTime ? new Date(p.checkInTime).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-';
        // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡πÜ (Ceil = ‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏®‡∏©‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
        let costShow = p.calculatedCost ? Math.ceil(p.calculatedCost) : 0;
       
        return `
            <tr>
                <td style="text-align:left">
                    ${p.name}
                    <div style="font-size:0.75em; color:gray;">(‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏≤ ${p.minutesPresent || 0} ‡∏ô.)</div>
                </td>
                <td>${time}</td>
                <td>${p.gamesPlayed}</td>
                <td>${p.wins}</td>
                <td style="font-weight:bold; color:#27ae60;">${costShow} ‡∏ø</td>
            </tr>`;
    }).join('');


    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    let repeats = [];
    for (const [key, count] of Object.entries(pairingHistory)) {
        if (count > 1) {
            const [id1, id2] = key.split('-');
            const p1 = players.find(p => p.id == id1); const p2 = players.find(p => p.id == id2);
            if (p1 && p2) repeats.push({ name: `${p1.name} + ${p2.name}`, count: count });
        }
    }
    repeats.sort((a, b) => b.count - a.count);
    repeatBody.innerHTML = repeats.length === 0 ? '<tr><td colspan="2" style="color:green;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥</td></tr>' : repeats.map(s => `<tr><td style="text-align:left;">${s.name}</td><td style="color:#e65100; font-weight:bold;">${s.count}</td></tr>`).join('');


    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateCost ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å updateCost (‡∏Å‡∏±‡∏ô Loop ‡∏ô‡∏£‡∏Å)
    if (!skipUpdateCost) updateCost();
}


function endSession() {
    const element = document.getElementById("summary-capture-area");
    html2canvas(element).then(canvas => {
        const link = document.createElement('a');
        link.download = 'badminton-summary.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}


// Modal & Queue
let currentBookingType = '';
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏ó‡∏µ‡∏° ‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
const openBookingModal = (type) => {
    currentBookingType = type;
    
    // ‚ú® ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ status='waiting' ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏≠‡∏≤‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á)
    const candidates = players
        .filter(p => !p.bookingId && !p.isResting)
        .sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏≠‡∏Å)
    const options = candidates.map(p => {
        const statusText = p.status === 'playing' ? ' (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô üè∏)' : '';
        return `<option value="${p.id}">${p.name}${statusText}</option>`;
    }).join('');
   
    let html = '';
    // ... (‡∏™‡πà‡∏ß‡∏ô HTML ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏Å‡πä‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) ...
    if (type === 'pair') {
        html += `<h4>üë• ‡∏à‡∏≠‡∏á‡∏Ñ‡∏π‡πà (2 ‡∏Ñ‡∏ô)</h4>`;
        html += `<label>‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å:</label><select id="b-p1" style="width:100%; margin-bottom:10px; padding:5px;">${options}</select>`;
        html += `<label>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á:</label><select id="b-p2" style="width:100%; margin-bottom:10px; padding:5px;">${options}</select>`;
    } else { 
        html += `<h4>‚öîÔ∏è ‡∏à‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå (4 ‡∏Ñ‡∏ô / 2 ‡∏ó‡∏µ‡∏°)</h4>`;
        html += `<div style="background:#ffcdd2; padding:10px; border-radius:8px; margin-bottom:10px;">`;
        html += `<strong style="color:#b71c1c;">Team 1 (‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π):</strong>`;
        html += `<select id="b-p1" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `<select id="b-p2" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `</div>`;
        html += `<div style="background:#bbdefb; padding:10px; border-radius:8px;">`;
        html += `<strong style="color:#0d47a1;">Team 2 (‡∏™‡∏µ‡∏ü‡πâ‡∏≤):</strong>`;
        html += `<select id="b-p3" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `<select id="b-p4" style="width:100%; margin:5px 0; padding:5px;">${options}</select>`;
        html += `</div>`;
    }
   
    document.getElementById('booking-inputs').innerHTML = html;
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û‡∏õ‡∏∏‡πà‡∏°
    const actions = document.querySelector('#booking-modal .modal-actions');
    if (actions) {
        actions.style.display = 'flex'; 
        actions.innerHTML = `<button class="secondary" onclick="closeModal('booking-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="success" onclick="confirmBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>`;
    }
    document.getElementById('booking-modal').style.display = 'flex';
};
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Team (1 ‡∏´‡∏£‡∏∑‡∏≠ 2) ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
const confirmBooking = () => {
    const ids = [];
    if (currentBookingType === 'pair') {
        ids.push({id: document.getElementById('b-p1').value, team: 1});
        ids.push({id: document.getElementById('b-p2').value, team: 1});
    } else {
        ids.push({id: document.getElementById('b-p1').value, team: 1}); // T1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1
        ids.push({id: document.getElementById('b-p2').value, team: 1}); // T1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2
        ids.push({id: document.getElementById('b-p3').value, team: 2}); // T2 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1
        ids.push({id: document.getElementById('b-p4').value, team: 2}); // T2 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2
    }


    // ‡∏î‡∏±‡∏Å Error: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ã‡πâ‡∏≥!
    const unique = new Set(ids.map(x => x.id));
    if (unique.size !== ids.length) { alert('‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!'); return; }


    const bId = 'book-' + (++bookingCounter);
   
    ids.forEach(x => {
        const p = players.find(pl => pl.id == x.id);
        if (p) {
            p.bookingId = bId;
            p.bookingTeam = x.team; // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        }
    });


    closeModal('booking-modal');
    updateQueueDisplay();
    renderCourts();
    saveData();
};
function updateQueueDisplay() {
    const list = document.getElementById('player-queue');
    const waiting = players.filter(p => p.status === 'waiting');
    waiting.sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);
    document.getElementById('queue-count').innerText = waiting.length;



    list.innerHTML = waiting.map((p, index) => {
        // ‚ú® NEW: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ó‡∏û! (‡∏•‡∏ö Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î)
        const estimatedWaitMins = getWaitTimeForQueue(index);
       
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢ (Badge Logic)
        let badgeClass = 'wait-green'; 
        let badgeText = `< ${estimatedWaitMins}m`; // Default
        
        if (estimatedWaitMins > 20) { 
            badgeClass = 'wait-red'; 
            badgeText = `~${estimatedWaitMins}m`; 
        } else if (estimatedWaitMins > 10) { 
            badgeClass = 'wait-orange'; 
            badgeText = `~${estimatedWaitMins}m`; 
        } else if (estimatedWaitMins > 5) {
            badgeText = `~${estimatedWaitMins}m`;
        } else if (estimatedWaitMins > 0) { 
             badgeText = `< ${estimatedWaitMins}m`; // ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        } else { 
            badgeText = '‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ'; 
            badgeClass = 'wait-green'; 
        }
       
        const itemClass = p.isResting ? 'player-item resting' : `player-item ${p.bookingId ? 'booked' : ''} ${p.isFastPass ? 'fastpass' : ''}`;
        const opacityStyle = p.isResting ? 'opacity: 0.6; background: #ddd;' : '';
        const namePrefix = p.isResting ? 'üí§ ' : (p.isFastPass ? 'üöÄ ' : '');


        // ‚ú® Level Badge
        const lv = p.level || 'BG';
        const lvColor = LEVEL_COLORS[lv] || '#bdbdbd';
        const levelBadge = `<span onclick="toggleLevel(${p.id})" style="cursor:pointer; background:${lvColor}; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-right:5px; font-weight:bold; border:1px solid rgba(0,0,0,0.1); box-shadow: 0 1px 2px rgba(0,0,0,0.2);" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö">${lv}</span>`;


        const waitBadge = !p.isResting
            ? `<span class="wait-badge ${badgeClass}" title="‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${estimatedWaitMins} ‡∏ô‡∏≤‡∏ó‡∏µ">${badgeText}</span>`
            : '<small style="color:gray; font-weight:bold; margin-left:5px;">(‡∏û‡∏±‡∏Å)</small>';


        return `
            <li class="${itemClass}" style="${opacityStyle}">
                <div class="player-info">
                    ${!p.isResting ? levelBadge : ''}
                    <strong>${namePrefix}${p.name}</strong>
                    ${p.bookingId ? `<small style="cursor:pointer; font-size:1.2em;" onclick="cancelBooking('${p.bookingId}')" title="‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á">üîí</small>` : ''}
                    ${waitBadge}
                </div>
               
                <button class="mini-btn ${p.isResting ? 'success' : 'secondary'}" style="margin-right:5px;" onclick="toggleRest(${p.id})">
                    ${p.isResting ? '‡∏ï‡∏∑‡πà‡∏ô' : 'üí§'}
                </button>
                <button class="mini-btn danger" onclick="removePlayer(${p.id})">√ó</button>
            </li>`;
    }).join('');
   
    updateNextMatchPanel();
}


function formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }


// ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à)
const cancelBooking = (bId) => {
    // ‡∏´‡∏≤‡∏î‡∏π‡∏ã‡∏¥‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á
    const group = players.filter(p => p.bookingId === bId);
    if(group.length === 0) return;


    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ (${group.map(p=>p.name).join(', ')}) ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? \n(‡∏Ñ‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)`)) return;
   
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Booking ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
    players.forEach(p => {
        if(p.bookingId === bId) {
            p.bookingId = null;
            p.bookingTeam = null;
        }
    });
    updateQueueDisplay();
    saveData();
};


// ‚ú® NEW: ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏û‡∏±‡∏Å/‡∏û‡∏£‡πâ‡∏≠‡∏°
const toggleRest = (id) => {
    const p = players.find(x => x.id === id);
    if (!p) return;
   
    // ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ boolean (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô false)
    p.isResting = !p.isResting;
   
    updateQueueDisplay();
    renderCourts(); // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß
};


// ‚ú® NEW: ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (Manual Add)
let currentManualAddCourtIdx = null;






const openManualAddModal = (courtIdx) => {
    // üî¥ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ countRealPlayers ‡πÅ‡∏ó‡∏ô .length ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    if (countRealPlayers(courts[courtIdx]) >= 4) { alert('‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô!'); return; }


    currentManualAddCourtIdx = courtIdx;


    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô‡∏£‡∏≠ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å, ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà)
    const waiting = players
        .filter(p => p.status === 'waiting' && !p.isResting)
        .sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);


    if (waiting.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏∞!'); return; }


    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô (List of Buttons)
    let html = `<h4>üëá ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${courtIdx + 1}</h4>`;
    html += `<div style="display:flex; flex-direction:column; gap:5px;">`;
   
    waiting.forEach(p => {
        let label = p.bookingId ? `üîí ${p.name} (Team)` : p.name;
        let style = p.bookingId ? 'background:#f3e5f5; color:#6a1b9a; border:1px solid #ce93d8;' : '';
       
        html += `<button class="secondary" style="text-align:left; ${style}" onclick="confirmManualAdd(${p.id})">
            ${p.isFastPass?'üöÄ ':''}${label} <small style="float:right;">(${p.gamesPlayed}P)</small>
        </button>`;
    });
   
    html += `</div>`;


    document.getElementById('booking-inputs').innerHTML = html;
   
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
    const modalActions = document.querySelector('#booking-modal .modal-actions');
    const oldActions = modalActions.innerHTML;
    modalActions.innerHTML = `<button class="secondary" onclick="closeModal('booking-modal'); restoreModal('${escape(oldActions)}');">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;
   
    document.getElementById('booking-modal').style.display = 'flex';
};


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏∏‡πà‡∏° Modal ‡πÄ‡∏î‡∏¥‡∏° (‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î)
window.restoreModal = (oldContent) => {
    document.querySelector('#booking-modal .modal-actions').innerHTML = unescape(oldContent);
};




// ‚ú® NEW: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° (‡∏â‡∏ö‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Fixed Slot)
const confirmManualAdd = (playerId) => {
    const court = courts[currentManualAddCourtIdx];
    const p = players.find(x => x.id === playerId);
    if (!p) return;
    if (countRealPlayers(court) >= 4) { alert('‡∏ä‡πâ‡∏≤‡πÑ‡∏õ! ‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß'); return; }

    p.status = 'playing';
    p.sessionGames = 0;
    if(p.isFastPass) p.isFastPass = false;
    
    // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    p.bookingId = null;
    p.bookingTeam = null;
   
    addPlayerToCourt(court, p);
    closeModal('booking-modal');
    
    // Restore buttons
    const actions = document.querySelector('#booking-modal .modal-actions');
    if (actions) actions.innerHTML = `<button class="secondary" onclick="closeModal('booking-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="success" onclick="confirmBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>`;

    renderCourts();
};

// ‚ú® NEW: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏≤‡πÄ‡∏ô‡∏•‡∏Ñ‡∏π‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next Match) - ‡πÅ‡∏ö‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏π‡πà
function updateNextMatchPanel() {
    const container = document.getElementById('next-match-list');
    const rule = document.getElementById('game-rule').value;
    const needed = (rule === 'winner_stay') ? 2 : 4;
   
    let html = '';
    let excludeIds = new Set(); // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Simulation
   
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ä‡∏ß‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏Ñ‡πà 4)
    const matchesToShow = Math.min(courtCount, 4);


    for (let i = 0; i < matchesToShow; i++) {
        // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÜ ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (excludeIds)
        const candidates = getSmartDraft(needed, excludeIds);
       
        if (candidates.length < needed) {
            if (i === 0) html += `<div style="text-align:center; width:100%; color: #ccc;">‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏µ‡∏° ...</div>`;
            break; // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡∏¢
        }


        // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        candidates.forEach(p => excludeIds.add(p.id));


        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Match ---
        html += `<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); min-width: 200px;">
            <div style="font-size:0.8em; color:#ddd; margin-bottom:5px;">üì¢ Match ${i + 1}</div>`;
       
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏¥‡πã‡∏ß
        const createCard = (p, color) => `
            <div style="background:white; color:#333; padding:4px 8px; margin:2px 0; border-radius:4px; border-left:4px solid ${color}; font-size:0.9em; display:flex; justify-content:space-between;">
                <span>${p.isFastPass?'üöÄ':''} ${p.name}</span>
                ${p.bookingId ? '<span style="font-size:0.8em;">üîí</span>' : ''}
            </div>`;


        if (needed === 4) {
            html += `<div style="display:flex; gap:5px;">
                        <div style="flex:1;">${createCard(candidates[0], '#e74c3c')}${createCard(candidates[1], '#e74c3c')}</div>
                        <div style="display:flex; align-items:center; font-weight:bold; color:#fff; font-size:0.8em;">VS</div>
                        <div style="flex:1;">${createCard(candidates[2], '#3498db')}${createCard(candidates[3], '#3498db')}</div>
                     </div>`;
        } else {
            html += `<div style="display:flex; flex-direction:column; gap:2px;">
                        ${createCard(candidates[0], '#f1c40f')}
                        ${createCard(candidates[1], '#f1c40f')}
                     </div>`;
        }
        html += `</div>`;
    }


    container.innerHTML = html;
}
    // ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó
// ‚ú® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó (‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á)
function editCourtName(idx) {
    const currentName = courts[idx].customName || `#${idx + 1}`;
    const newName = prompt(`‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà ${idx + 1} ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏î‡∏¥‡∏°: ${currentName})`, currentName);
   
    if (newName && newName.trim() !== "") {
        courts[idx].customName = newName.trim();
        renderCourts();
    }
}
init();
// ==========================================
// üì° BROADCAST SYSTEM (LIVE SYNC)
// ==========================================


// ‚úÖ ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å index.html):
const isViewer = (typeof APP_MODE !== 'undefined' && APP_MODE === 'viewer');
let syncInterval = null;


// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Viewer ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
if (isViewer) {
    console.log("üëÄ VIEW MODE ACTIVATED");
    document.body.classList.add('view-mode');
   
    // ‚ú® UPDATE: ‡∏™‡∏±‡πà‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å "‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 15 ‡∏ß‡∏¥)
    google.script.run.withSuccessHandler(restoreState).syncLoadState();
   
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Loop ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤)
    setInterval(() => {
        google.script.run.withSuccessHandler(restoreState).syncLoadState();
    }, 15000);
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏™‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Master ‡∏Å‡∏î)
function toggleBroadcast() {
    const btn = document.getElementById('btn-broadcast');
   
    if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
        btn.innerHTML = 'üì° ‡πÄ‡∏£‡∏¥‡πà‡∏° Live';
        btn.classList.remove('pulse');
        alert('üì¥ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£ Live ‡πÅ‡∏•‡πâ‡∏ß');
    } else {
        if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏° "‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏™‡∏î" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á URL ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? \n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)')) return;
       
        syncInterval = setInterval(pushDataToCloud, 10000);
        pushDataToCloud();
       
        btn.innerHTML = 'üî¥ On Air';
        btn.classList.add('pulse');
       
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Modal ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ url ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
        showShareLinkModal();
    }
}


// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Cloud (Master Only)
function pushDataToCloud() {
    // ‡∏¢‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ï‡∏±‡∏î Logs ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏ï‡πá‡∏°)
    const state = {
        players: players,
        courts: courts,
        courtCount: courtCount, // ‚ú® ‡∏™‡πà‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        gameRule: document.getElementById('game-rule').value, // ‚ú® ‡∏™‡πà‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        timestamp: Date.now()
    };
    const json = JSON.stringify(state);
    google.script.run.syncSaveState(json);
    console.log("Cloud Synced ‚òÅÔ∏è");
}



// ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (Viewer Only)
function restoreState(json) {
    // ‚ú® FIX UI FREEZE: ‡∏ñ‡πâ‡∏≤ Viewer ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏î Modal (‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠ setting) ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á Render ‡∏ó‡∏±‡∏ö
    if (isModalOpen()) return;


    if (!json) return;
    const state = JSON.parse(json);
   
    players = state.players;
   
    // ‚ú® Sync settings: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÅ‡∏•‡∏∞‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤
    if (state.courtCount) {
        courtCount = state.courtCount;
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Input ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà)
        const calcInput = document.getElementById('calc-court-count');
        if (calcInput) calcInput.value = courtCount;
    }
    if (state.gameRule) {
        const ruleSelect = document.getElementById('game-rule');
        if (ruleSelect) ruleSelect.value = state.gameRule;
    }
   
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≠‡∏£‡πå‡∏ó
    courts = state.courts.map(c => {
        c.interval = null;
        return c;
    });


    renderCourts();
    updateQueueDisplay();
    updateNextMatchPanel();
}


// Modal ‡πÅ‡∏à‡∏Å‡∏ß‡∏≤‡∏õ
function showShareLinkModal() {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏î‡∏π (‡πÄ‡∏≠‡∏≤ URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + ?mode=viewer)
    const baseUrl = (typeof APP_URL !== 'undefined' && APP_URL) ? APP_URL : window.location.href.split('?')[0];
    const viewerUrl = baseUrl + '?mode=viewer';
   
    const html = `
        <div style="text-align:center;">
            <h3>üì° ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (View Only)</h3>
            <p>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÅ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏ß ‡πÅ‡∏ï‡πà‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>
            <input type="text" value="${viewerUrl}" id="share-link-input" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
            <button class="success" onclick="copyShareLink()">üìã Copy Link</button>
            <button class="secondary" onclick="closeModal('booking-modal')">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
   
    document.getElementById('booking-inputs').innerHTML = html;
    document.getElementById('booking-modal').style.display = 'flex';
   
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Action ‡πÄ‡∏î‡∏¥‡∏°
    document.querySelector('#booking-modal .modal-actions').style.display = 'none';
}


function copyShareLink() {
    const copyText = document.getElementById("share-link-input");
    copyText.select();
    document.execCommand("copy");
    alert("‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÇ‡∏•‡∏î");
}
// üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏µ‡πà "‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πâ‡∏≥‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" (Conflict Score ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)
// 3.1 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ)
function getAverageGameTime() {
    if (completedGameTimes.length === 0) return DEFAULT_GAME_TIME;
    const sum = completedGameTimes.reduce((a, b) => a + b, 0);
    return Math.round(sum / completedGameTimes.length);
}

// 3.2 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÅ‡∏ö‡∏ö Real-time (‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î!)
// ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getWaitTimeForQueue
function getWaitTimeForQueue(queueIndex) {
    const avgTime = getAverageGameTime(); 
    const now = Date.now();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Slots ‡∏ß‡πà‡∏≤‡∏á
    let availableSlots = [];
    
    courts.forEach(c => {
        // ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ Rule ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏ó
        const rule = c.rule || 'normal';
        const isWinnerStay = (rule === 'winner_stay');
        const spotsPerCourt = isWinnerStay ? 2 : 4; // ‡∏ñ‡πâ‡∏≤ Winner Stay ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 2, ‡∏ñ‡πâ‡∏≤ Normal ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ 4

        let freeAt = now;
        if (c.gameStartTime) {
            let expected = c.gameStartTime + (avgTime * 60000);
            if (expected < now) expected = now + 30000;
            freeAt = expected;
        }
        
        // ‡πÅ‡∏ï‡∏Å Slot ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏±‡πâ‡∏ô‡πÜ
        for (let k = 0; k < spotsPerCourt; k++) {
            availableSlots.push(freeAt);
        }
    });

    availableSlots.sort((a, b) => a - b);

    // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞) ...
    if (queueIndex < availableSlots.length) {
        const mySlotTime = availableSlots[queueIndex];
        return Math.max(0, Math.round((mySlotTime - now) / 60000));
    } else {
        const totalCapacity = availableSlots.length;
        const cycles = Math.floor(queueIndex / totalCapacity);
        const remainder = queueIndex % totalCapacity;
        const baseSlotTime = availableSlots[remainder]; 
        const waitMs = (baseSlotTime - now) + (cycles * avgTime * 60000);
        return Math.max(0, Math.round(waitMs / 60000));
    }
}


</script>


