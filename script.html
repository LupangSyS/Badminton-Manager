<script>
// ==========================================
// 1. CONFIG & DATA
// ==========================================
const STORAGE_KEY = 'BADMINTON_MANAGER_V9_FIXED'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
const isViewer = (typeof APP_MODE !== 'undefined' && APP_MODE === 'viewer');

let players = []; 
let courts = [];  
let courtCount = 2;
let bookingCounter = 0;
let pairingHistory = {};
let opponentHistory = {}; 
let matchLogs = [];
let activeGameResolveCourtId = null;
let syncInterval = null;

const LEVEL_COLORS = { 'BG': '#bdbdbd', 'N': '#66bb6a', 'S': '#ffa726', 'P': '#ef5350' };
const LEVEL_WEIGHTS = { 'BG': 1, 'N': 2, 'S': 3, 'P': 4 };
const AVG_GAME_DURATION = 15;
const AUTO_START_DELAY = 30;

// ==========================================
// 2. HELPER FUNCTIONS
// ==========================================

function isModalOpen() {
    const b = document.getElementById('booking-modal');
    const w = document.getElementById('winner-modal');
    return (b && b.style.display === 'flex') || (w && w.style.display === 'flex');
}

function formatTime(s) { 
    return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; 
}

function countRealPlayers(court) {
    if(!court || !court.players) return 0;
    return court.players.filter(p => p !== null && p !== undefined).length;
}

function getPairKey(id1, id2) { return id1 < id2 ? `${id1}-${id2}` : `${id2}-${id1}`; }
function recordPairing(id1, id2) { const k=getPairKey(id1,id2); pairingHistory[k] = (pairingHistory[k]||0)+1; }
function getPairCount(id1, id2) { return pairingHistory[getPairKey(id1,id2)] || 0; }
function recordOpponent(id1, id2) { const k=getPairKey(id1,id2); opponentHistory[k] = (opponentHistory[k]||0)+1; }
function getOpponentCount(id1, id2) { return opponentHistory[getPairKey(id1,id2)] || 0; }

// ==========================================
// 3. PERSISTENCE (SAVE/LOAD)
// ==========================================

function saveData() {
    if (isViewer) return; 
    const data = {
        players,
        courts: courts.map(c => ({...c, interval: null})),
        courtCount,
        pairingHistory,
        opponentHistory,
        matchLogs,
        bookingCounter,
        gameRule: document.getElementById('game-rule').value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    try {
        const data = JSON.parse(raw);
        players = data.players || [];
        courtCount = data.courtCount || 2;
        pairingHistory = data.pairingHistory || {};
        opponentHistory = data.opponentHistory || {};
        matchLogs = data.matchLogs || [];
        bookingCounter = data.bookingCounter || 0;
        
        // Restore Courts
        if (data.courts) {
            courts = data.courts.map((c, idx) => {
                c.interval = null;
                if (c.state === 'playing') {
                    c.interval = setInterval(() => { 
                        c.timer++; 
                        const el = document.getElementById(`timer-${idx}`);
                        if(el) el.innerText = formatTime(c.timer); 
                    }, 1000);
                }
                return c;
            });
        }
        
        if (data.gameRule) {
            const el = document.getElementById('game-rule');
            if(el) el.value = data.gameRule;
        }
        return true;
    } catch (e) { console.error(e); return false; }
}

// ==========================================
// 4. CORE LOGIC & ACTIONS
// ==========================================

function autoBalanceTeam(candidates) {
    if (candidates.some(p => p.bookingId) || candidates.length !== 4) return candidates;

    const combinations = [[0, 1, 2, 3], [0, 2, 1, 3], [0, 3, 1, 2]];
    let bestCombo = combinations[0];
    let minScore = Infinity;

    combinations.forEach(combo => {
        const p1 = candidates[combo[0]], p2 = candidates[combo[1]];
        const p3 = candidates[combo[2]], p4 = candidates[combo[3]];

        const t1 = (LEVEL_WEIGHTS[p1.level||'BG']||1) + (LEVEL_WEIGHTS[p2.level||'BG']||1);
        const t2 = (LEVEL_WEIGHTS[p3.level||'BG']||1) + (LEVEL_WEIGHTS[p4.level||'BG']||1);
        const diff = Math.abs(t1 - t2);

        let penalty = 0;
        if (diff > 2) penalty += 1000000;
        if (getPairCount(p1.id, p2.id) >= 1) penalty += 1000000;
        if (getPairCount(p3.id, p4.id) >= 1) penalty += 1000000;
        
        let fatigue = getOpponentCount(p1.id, p3.id) + getOpponentCount(p1.id, p4.id) +
                      getOpponentCount(p2.id, p3.id) + getOpponentCount(p2.id, p4.id);
        penalty += (fatigue * 300);

        if ((diff + penalty) < minScore) {
            minScore = diff + penalty;
            bestCombo = combo;
        }
    });

    return [candidates[bestCombo[0]], candidates[bestCombo[1]], candidates[bestCombo[2]], candidates[bestCombo[3]]];
}

function getSmartDraft(count, excludeIds = new Set()) {
    let pool = players.filter(p => p.status === 'waiting' && !p.isResting && !excludeIds.has(p.id));
    pool.sort((a, b) => a.joinedQueueAt - b.joinedQueueAt);
    if (pool.length === 0) return [];

    for (let i = 0; i < pool.length; i++) {
        let team = tryBuildTeam(pool[i], pool, count);
        if (team.length === count) {
            if (count === 4) return autoBalanceTeam(team);
            return team;
        }
    }
    return [];
}

function tryBuildTeam(captain, currentPool, targetCount) {
    let selected = [], usedIds = new Set();

    if (captain.bookingId) {
        const group = currentPool.filter(x => x.bookingId === captain.bookingId);
        if (group.length > targetCount) return [];
        group.sort((a, b) => (a.bookingTeam || 0) - (b.bookingTeam || 0));
        group.forEach(p => { selected.push(p); usedIds.add(p.id); });
    } else {
        selected.push(captain);
        usedIds.add(captain.id);
    }

    while (selected.length < targetCount) {
        let nextPlayer = null;
        if (selected.length % 2 !== 0 && !selected[selected.length-1].bookingId) {
            let best = null, minScore = Infinity;
            const soloist = selected[selected.length - 1];
            
            for (let i = 0; i < currentPool.length; i++) {
                const c = currentPool[i];
                if (c.id === soloist.id || usedIds.has(c.id) || c.bookingId) continue;
                const count = getPairCount(soloist.id, c.id);
                const score = (count >= 2 ? 999999999 : count * 1000000) + i;
                if (score < minScore) { minScore = score; best = c; }
            }
            nextPlayer = best;
        } else {
            nextPlayer = currentPool.find(p => !usedIds.has(p.id) && !p.bookingId);
        }

        if (nextPlayer) { selected.push(nextPlayer); usedIds.add(nextPlayer.id); } 
        else break;
    }
    return selected;
}

function autoFillCourts() {
    courts.forEach((court, idx) => {
        if (!court.isOpened || court.state !== 'empty') return;
        
        if (countRealPlayers(court) === 4) {
            if (!court.autoStartTarget) {
                court.autoStartTarget = Date.now() + (AUTO_START_DELAY * 1000);
                renderCourts();
            } else if (Date.now() >= court.autoStartTarget) {
                startGame(idx);
            } else {
                const btn = document.querySelector(`#court-${idx} .btn-auto-start`);
                if (btn) btn.innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${Math.ceil((court.autoStartTarget - Date.now())/1000)}s)`;
            }
        } else {
            court.autoStartTarget = null;
        }
    });
}

function addPlayers() {
    const txt = document.getElementById('new-players').value.trim();
    if(!txt) return;
    txt.split('\n').map(n=>n.trim()).filter(n=>n).forEach(name => {
        players.push({ id: Date.now()+Math.random(), name, level:'BG', gamesPlayed:0, wins:0, sessionGames:0, status:'waiting', joinedQueueAt: Date.now(), checkInTime: new Date() });
    });
    document.getElementById('new-players').value = '';
    updateQueueDisplay(); saveData();
}

function removePlayer(id) {
    const p = players.find(x => x.id === id);
    if (!p) return;
    if(p.status === 'playing') { alert('‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return; }
    if(!confirm('‡∏•‡∏ö‡∏ô‡∏∞?')) return;
    players = players.filter(x => x.id !== id);
    updateQueueDisplay(); saveData();
}

function fillCourtSmart(idx) {
    const court = courts[idx];
    const needed = 4 - countRealPlayers(court);
    const candidates = getSmartDraft(needed);
    if(candidates.length === 0) { alert('‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ / ‡∏ï‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏ã‡πâ‡∏≥'); return; }
    
    candidates.forEach(p => { 
        p.status = 'playing'; p.sessionGames = 0; p.isFastPass = false;
        let emptyIdx = court.players.findIndex(x => x==null);
        if(emptyIdx !== -1) court.players[emptyIdx] = p; else court.players.push(p);
    });
    renderCourts(); saveData();
}
function fillCourtQueue(idx) { fillCourtSmart(idx); }

function startGame(idx) {
    const c = courts[idx];
    c.state = 'playing'; c.timer = 0; c.autoStartTarget = null;
    
    const p = c.players;
    if(p[0]&&p[1]) recordPairing(p[0].id, p[1].id);
    if(p[2]&&p[3]) recordPairing(p[2].id, p[3].id);
    if(p[0]&&p[2]) recordOpponent(p[0].id, p[2].id);
    if(p[0]&&p[3]) recordOpponent(p[0].id, p[3].id);
    if(p[1]&&p[2]) recordOpponent(p[1].id, p[2].id);
    if(p[1]&&p[3]) recordOpponent(p[1].id, p[3].id);

    c.interval = setInterval(() => { c.timer++; document.getElementById(`timer-${idx}`).innerText = formatTime(c.timer); }, 1000);
    renderCourts(); saveData();
}

function stopGame(idx) {
    const c = courts[idx]; clearInterval(c.interval);
    // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
    c.players.forEach(p => { 
        if(p) { 
            const pl=players.find(x=>x.id===p.id); 
            if(pl){ 
                pl.gamesPlayed++; 
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô session ‡∏ô‡∏µ‡πâ
                pl.sessionGames = (pl.sessionGames || 0) + 1; 
            } 
        } 
    });
    activeGameResolveCourtId = idx;
    document.getElementById('winner-modal').style.display = 'flex';
}

function resolveGame(winTeamIdx) {
    const c = courts[activeGameResolveCourtId];
    document.getElementById('winner-modal').style.display = 'none';
    
    if (winTeamIdx === -1) {
        c.players.forEach(p => { if(p) sendToQueue(p.id); });
        c.players = []; c.state = 'post_game';
    } else {
        const t1 = [c.players[0], c.players[1]], t2 = [c.players[2], c.players[3]];
        const winners = (winTeamIdx===0)?t1:t2, losers = (winTeamIdx===0)?t2:t1;
        
        matchLogs.unshift({
            time: new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}),
            court: activeGameResolveCourtId+1,
            winners: winners.map(p=>p?p.name:'?').join(','),
            losers: losers.map(p=>p?p.name:'?').join(','),
            duration: formatTime(c.timer)
        });
        renderMatchLog(); // ‚ú® ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î Log ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        
        winners.forEach(p => { 
            if(p) { const pl=players.find(x=>x.id===p.id); if(pl) pl.wins++; } 
        });
        
        // --- üî• ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å Winner Stay (Fixed Quota) ---
        const rule = document.getElementById('game-rule').value;
        let stayers=[], leavers=[];
        
        if (rule === 'normal') {
            leavers.push(...t1, ...t2);
        } else {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏à‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á" ‡πÉ‡∏ô players array (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
            const getSessionGames = (tempP) => {
                if(!tempP) return 99; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å
                const realP = players.find(x => x.id === tempP.id);
                return realP ? (realP.sessionGames || 0) : 99;
            };

            const q1 = getSessionGames(winners[0]);
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß < 2 ‡πÄ‡∏Å‡∏° (‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 1) -> ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö 2 ‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 2) -> ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
            if (q1 < 2) {
                stayers.push(...winners);
                leavers.push(...losers);
            } else {
                leavers.push(...winners, ...losers); // ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î
            }
        }
        
        leavers.forEach(p => { if(p) sendToQueue(p.id); });
        
        // ‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
        c.players = [null, null, null, null]; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
        if (stayers.length > 0) {
            c.players[0] = stayers[0];
            c.players[1] = stayers[1];
        }
        c.state = stayers.length > 0 ? 'empty' : 'post_game'; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô empty ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°
    }
    c.timer = 0; renderCourts(); saveData();
}

function sendToQueue(id) { 
    const pl = players.find(x=>x.id===id); 
    if(pl) { 
        pl.status='waiting'; 
        pl.joinedQueueAt=Date.now(); 
        pl.bookingId=null; 
        pl.bookingTeam=null; 
        pl.sessionGames=0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß
    } 
}

function kickPlayer(cIdx, sIdx) {
    const c = courts[cIdx];
    const p = c.players[sIdx];
    if(!p) return;
    if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß ${p.name} ‡∏≠‡∏≠‡∏Å?`)) return;
    
    sendToQueue(p.id);
    c.players[sIdx] = null;
    if(c.state==='playing') { clearInterval(c.interval); c.state='empty'; }
    c.autoStartTarget = null;
    renderCourts(); saveData();
}

// --- üî• ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å Reset ‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Manual Clear) ---
function resetAll() { 
    if(!confirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)?')) return;
    
    // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    players = [];
    courts.forEach(c => clearInterval(c.interval));
    courts = [];
    pairingHistory = {};
    opponentHistory = {};
    matchLogs = [];
    bookingCounter = 0;
    
    // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Storage
    localStorage.removeItem(STORAGE_KEY);
    
    // 3. ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Reload)
    renderCourts();
    updateQueueDisplay();
    updateDashboard();
    renderMatchLog();
    
    alert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
}

function resetStatsOnly() { 
    if(!confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)?')) return;
    players.forEach(p=>{
        p.gamesPlayed=0; p.wins=0; p.sessionGames=0;
        p.status = 'waiting';
        p.bookingId = null;
    });
    pairingHistory = {};
    opponentHistory = {};
    matchLogs = [];
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ô‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢
    courts.forEach(c => {
        clearInterval(c.interval);
        c.players = []; c.state = 'empty'; c.timer = 0; c.isOpened = false;
    });
    
    saveData();
    renderCourts();
    updateQueueDisplay();
    updateDashboard();
    renderMatchLog();
    alert('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!');
}

// ==========================================
// 5. RENDER SYSTEM (UI)
// ==========================================

function renderCourts() {
    if (isModalOpen()) return;
    const container = document.getElementById('courts-container');
    
    while (courts.length < courtCount) courts.push({ id: courts.length, players: [null,null,null,null], state: 'empty', timer: 0, interval: null, isOpened: false });
    while (courts.length > courtCount) { const rm = courts.pop(); if(rm && rm.interval) clearInterval(rm.interval); }

    container.innerHTML = '';
    courts.forEach((court, index) => {
        let overlayHTML = '';
        if (court.state === 'post_game') {
            overlayHTML = `<div class="court-overlay"><button class="btn-overlay btn-call" onclick="triggerFill(${index})">üì¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á</button><button class="btn-overlay btn-rest" onclick="closeAndRest(${index})">üî¥ ‡∏û‡∏±‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</button></div>`;
        } else if (!court.isOpened) {
            overlayHTML = `<div class="court-overlay"><button class="btn-overlay btn-open" onclick="openCourt(${index})">üîî ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°</button></div>`;
        }

        const displayName = court.customName || `#${index + 1}`;
        const ruleLabel = document.getElementById('game-rule').value === 'winner_stay' ? "Fixed Quota" : "";

        container.innerHTML += `
            <div class="court" id="court-${index}">
                <div class="court-lines"></div><div class="service-line-top"></div><div class="service-line-bottom"></div>
                <div class="court-header" style="position:relative; z-index:10;">
                    <span onclick="editCourtName(${index})" style="cursor:pointer; display:flex; gap:5px;">${displayName} <small>‚úèÔ∏è</small></span>
                    <small>${ruleLabel}</small>
                </div>
                ${overlayHTML}
                <div class="court-players">
                    <div class="team team-pink">${renderP(court.players[0],index,0)}${renderP(court.players[1],index,1)}</div>
                    <div class="team team-blue">${renderP(court.players[2],index,2)}${renderP(court.players[3],index,3)}</div>
                </div>
                <div class="court-controls">
                    <div class="timer" id="timer-${index}">${formatTime(court.timer)}</div>
                    ${renderControls(court, index)}
                </div>
            </div>`;
    });
    
    updateQueueDisplay();
    updateDashboard(); // ‚ú® ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Dashboard ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏ó
}

function renderP(p, cIdx, sIdx) {
    if (!p) return `<div class="player-on-court" style="opacity:0.7; border:2px dashed #ccc;" onclick="openManualAddModal(${cIdx})">+ ‡∏ß‡πà‡∏≤‡∏á</div>`;
    const badge = (document.getElementById('game-rule').value === 'winner_stay') ? `<span class="quota-badge" style="background:${p.sessionGames>=1?'#e67e22':'#27ae60'}">G: ${p.sessionGames+1}/2</span>` : '';
    return `<div class="player-on-court" onclick="kickPlayer(${cIdx}, ${sIdx})"><strong>${p.name}</strong><small>(${p.gamesPlayed}P)</small>${badge}</div>`;
}

function renderControls(court, idx) {
    if (!court.isOpened || court.state === 'post_game') return `<button class="secondary" style="width:100%;" disabled>...</button>`;
    if (court.state === 'playing') return `<button class="danger" style="width:100%;" onclick="stopGame(${idx})">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>`;

    const realCount = countRealPlayers(court);
    if (realCount === 4) {
        if (court.autoStartTarget) {
            const rem = Math.ceil((court.autoStartTarget - Date.now())/1000);
            if(rem > 0) return `<button class="success btn-auto-start" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏° (Auto ${rem}s)</button>`;
        }
        return `<button class="success" style="width:100%;" onclick="startGame(${idx})">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>`;
    }

    // Logic Booking Button
    const waiting = players.filter(p => p.status === 'waiting').sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);
    const head = waiting.length > 0 ? waiting[0] : null;
    const needed = 4 - realCount;
    let isBookingPair = false, isBookingFour = false, bookingSize = 0;

    if (head && head.bookingId) {
        const group = waiting.filter(p => p.bookingId === head.bookingId);
        bookingSize = group.length;
        if (bookingSize <= needed) {
            if (bookingSize === 2) isBookingPair = true;
            if (bookingSize === 4) isBookingFour = true;
        }
    }
    const dis = "background:#e0e0e0; color:#a0a0a0; cursor:not-allowed;";
    const act2 = "background:#9b59b6; color:white;";
    const act4 = "background:#8e44ad; color:white;";

    return `<div style="display:flex; flex-direction:column; gap:4px;">
        <div style="display:flex; gap:4px;">
            <button class="warning" style="flex:1;" onclick="fillCourtSmart(${idx})">üé≤ ‡∏™‡∏∏‡πà‡∏°</button>
            <button class="secondary" style="background:#3498db; color:white; flex:1;" onclick="fillCourtQueue(${idx})">‚è© ‡∏Ñ‡∏¥‡∏ß</button>
        </div>
        <div style="display:flex; gap:4px;">
            <button style="flex:1; ${isBookingPair?act2:dis}" ${isBookingPair?`onclick="fillCourtSmart(${idx})"`:'disabled'}>üë• ‡∏Ñ‡∏π‡πà ${isBookingPair?'‚úÖ':''}</button>
            <button style="flex:1; ${isBookingFour?act4:dis}" ${isBookingFour?`onclick="fillCourtSmart(${idx})"`:'disabled'}>‚öîÔ∏è 4 ${isBookingFour?'‚úÖ':''}</button>
        </div>
    </div>`;
}

// ‚ú® ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Dashboard ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
function updateDashboard() {
    const tbody = document.getElementById('stats-body');
    if(!tbody) return;
    const sortType = document.getElementById('sort-select').value;
    
    let sorted = [...players].sort((a, b) => {
        if (sortType === 'games_desc') return b.gamesPlayed - a.gamesPlayed;
        if (sortType === 'games_asc') return a.gamesPlayed - b.gamesPlayed;
        if (sortType === 'wins_desc') return b.wins - a.wins;
        return 0;
    });

    tbody.innerHTML = sorted.map((p, index) => {
        let rank = index + 1;
        let medal = '';
        if (rank === 1) medal = 'ü•á'; else if (rank === 2) medal = 'ü•à'; else if (rank === 3) medal = 'ü•â';
        const rate = p.gamesPlayed > 0 ? Math.round((p.wins / p.gamesPlayed) * 100) : 0;
        return `<tr><td>${medal} ${rank}</td><td>${p.name}</td><td>${p.gamesPlayed}</td><td>${p.wins}</td><td>${rate}%</td></tr>`;
    }).join('');
}

// ‚ú® ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô History Log ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
function renderMatchLog() {
    const tbody = document.getElementById('match-log-body');
    if(!tbody) return;
    if (matchLogs.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="color:gray;">-</td></tr>'; return; }
    tbody.innerHTML = matchLogs.map(log => `<tr><td>${log.time}</td><td>${log.court}</td><td class="log-winner">${log.winners}</td><td class="log-loser">${log.losers}</td><td>${log.duration}</td></tr>`).join('');
}

function updateQueueDisplay() {
    const list = document.getElementById('player-queue');
    const count = document.getElementById('queue-count');
    if(!list) return;

    const waiting = players.filter(p => p.status === 'waiting').sort((a,b) => a.joinedQueueAt - b.joinedQueueAt);
    if(count) count.innerText = waiting.length;
    
    list.innerHTML = waiting.map(p => {
        const lvColor = LEVEL_COLORS[p.level||'BG'];
        const lvBadge = `<span onclick="toggleLevel(${p.id})" style="cursor:pointer; background:${lvColor}; color:white; padding:2px 5px; border-radius:4px; font-size:0.8em; margin-right:5px;">${p.level||'BG'}</span>`;
        const cls = p.isResting ? 'player-item resting' : `player-item ${p.bookingId?'booked':''} ${p.isFastPass?'fastpass':''}`;
        const style = p.isResting ? 'opacity:0.6; background:#ddd;' : '';
        
        return `<li class="${cls}" style="${style}">
            <div class="player-info">
                ${!p.isResting ? lvBadge : ''} <strong>${p.name}</strong>
                ${p.bookingId ? `<small onclick="cancelBooking('${p.bookingId}')" style="cursor:pointer;">üîí</small>` : ''}
            </div>
            <button class="mini-btn ${p.isResting?'success':'secondary'}" onclick="toggleRest(${p.id})">${p.isResting?'‡∏ï‡∏∑‡πà‡∏ô':'üí§'}</button>
            <button class="mini-btn danger" onclick="removePlayer(${p.id})">√ó</button>
        </li>`;
    }).join('');
    updateNextMatchPanel();
}

function updateNextMatchPanel() {
    const container = document.getElementById('next-match-list');
    if(!container) return;
    const rule = document.getElementById('game-rule').value;
    const needed = (rule === 'winner_stay') ? 2 : 4;
    const matchesToShow = Math.min(courtCount, 4);
    let html = '', excludeIds = new Set();

    for (let i = 0; i < matchesToShow; i++) {
        const candidates = getSmartDraft(needed, excludeIds);
        if (candidates.length < needed) {
            if (i===0) html += `<div style="text-align:center; color:#ccc;">‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏µ‡∏°...</div>`;
            break;
        }
        candidates.forEach(p => excludeIds.add(p.id));
        
        const createCard = (p, c) => `<div style="background:white; color:#333; padding:2px 5px; margin:2px 0; border-radius:3px; border-left:3px solid ${c}; font-size:0.85em;">${p.name}</div>`;
        
        html += `<div style="background:rgba(255,255,255,0.1); padding:5px; border-radius:6px; min-width:180px;">
            <div style="font-size:0.7em; color:#ddd;">Match ${i+1}</div>`;
            
        if (needed === 4) {
            html += `<div style="display:flex; gap:5px;">
                <div style="flex:1;">${createCard(candidates[0],'#e74c3c')}${createCard(candidates[1],'#e74c3c')}</div>
                <div style="color:white; font-size:0.8em; align-self:center;">VS</div>
                <div style="flex:1;">${createCard(candidates[2],'#3498db')}${createCard(candidates[3],'#3498db')}</div>
            </div>`;
        } else {
            html += `<div style="display:flex; flex-direction:column; gap:2px;">${createCard(candidates[0],'#f1c40f')}${createCard(candidates[1],'#f1c40f')}</div>`;
        }
        html += `</div>`;
    }
    container.innerHTML = html;
}

// ==========================================
// 6. ACTIONS (OTHER)
// ==========================================

function toggleLevel(id) {
    const p = players.find(x => x.id === id);
    const lvls = ['BG','N','S','P'];
    p.level = lvls[(lvls.indexOf(p.level||'BG')+1)%4];
    updateQueueDisplay(); saveData();
}

function toggleRest(id) {
    const p = players.find(x => x.id === id);
    p.isResting = !p.isResting;
    updateQueueDisplay(); renderCourts(); saveData();
}

function cancelStopGame() { 
    const c = courts[activeGameResolveCourtId];
    c.players.forEach(p => { if(p) { const pl=players.find(x=>x.id===p.id); if(pl){ pl.gamesPlayed--; pl.sessionGames = Math.max(0, (pl.sessionGames||1)-1); } } });
    c.interval = setInterval(() => { c.timer++; document.getElementById(`timer-${activeGameResolveCourtId}`).innerText = formatTime(c.timer); }, 1000);
    document.getElementById('winner-modal').style.display='none'; 
}

function openCourt(idx) { courts[idx].isOpened=true; renderCourts(); saveData(); }
function closeAndRest(idx) { courts[idx].isOpened=false; triggerFill(idx); }
function triggerFill(idx) { courts[idx].players.forEach(p=>sendToQueue(p.id)); courts[idx].players=[]; courts[idx].state='empty'; renderCourts(); saveData(); }
function updateCourts(n) { courtCount+=n; if(courtCount<1) courtCount=1; renderCourts(); saveData(); }
function editCourtName(idx) { const n=prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó:"); if(n) { courts[idx].customName=n; renderCourts(); saveData(); } }
function updateCustomHoursInputs() { /* Placeholder */ } // ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô Error

// ==========================================
// 7. BOOKING & MODALS
// ==========================================
let currentBookingType='';
function openBookingModal(type) {
    currentBookingType = type;
    const waiting = players.filter(p=>p.status==='waiting'&&!p.bookingId&&!p.isResting).sort((a,b)=>a.joinedQueueAt-b.joinedQueueAt);
    const opts = waiting.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    
    let html = '';
    if(type==='pair') {
        html = `<h4>üë• ‡∏à‡∏≠‡∏á‡∏Ñ‡∏π‡πà</h4><label>P1:</label><select id="bp1">${opts}</select><label>P2:</label><select id="bp2">${opts}</select>`;
    } else {
        html = `<h4>‚öîÔ∏è ‡∏à‡∏≠‡∏á 4</h4><div style="background:#ffcdd2; padding:5px;">Team1: <select id="bp1">${opts}</select><select id="bp2">${opts}</select></div>
        <div style="background:#bbdefb; padding:5px;">Team2: <select id="bp3">${opts}</select><select id="bp4">${opts}</select></div>`;
    }
    document.getElementById('booking-inputs').innerHTML = html;
    document.getElementById('booking-modal').style.display='flex';
}
function confirmBooking() {
    const ids = [];
    if(currentBookingType==='pair') ids.push({id:val('bp1'),t:1},{id:val('bp2'),t:1});
    else ids.push({id:val('bp1'),t:1},{id:val('bp2'),t:1},{id:val('bp3'),t:2},{id:val('bp4'),t:2});
    
    const u = new Set(ids.map(x=>x.id));
    if(u.size !== ids.length) { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥'); return; }
    
    const bid = 'book-'+(++bookingCounter);
    ids.forEach(x => { const p=players.find(pl=>pl.id==x.id); if(p){ p.bookingId=bid; p.bookingTeam=x.t; } });
    closeModal('booking-modal'); updateQueueDisplay(); renderCourts(); saveData();
}
function val(id) { return document.getElementById(id).value; }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function cancelBooking(bid) { 
    if(!confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ?')) return;
    players.forEach(p=>{if(p.bookingId===bid){p.bookingId=null;p.bookingTeam=null;}});
    updateQueueDisplay(); saveData();
}

let currentManualAddCourtIdx = null;
function openManualAddModal(idx) {
    if(countRealPlayers(courts[idx])>=4) { alert('‡πÄ‡∏ï‡πá‡∏°'); return; }
    currentManualAddCourtIdx = idx;
    const waiting = players.filter(p=>p.status==='waiting'&&!p.isResting).sort((a,b)=>a.joinedQueueAt-b.joinedQueueAt);
    if(waiting.length===0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠'); return; }
    
    let html = `<h4>üëá ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏•‡∏á ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${idx+1}</h4><div style="display:flex; flex-direction:column; gap:5px;">`;
    waiting.forEach(p => {
        html += `<button class="secondary" style="text-align:left; ${p.bookingId?'border:1px solid purple':''}" onclick="confirmManualAdd(${p.id})">
            ${p.name} ${p.bookingId?'(Team)':''}
        </button>`;
    });
    html += `</div>`;
    document.getElementById('booking-inputs').innerHTML = html;
    
    // Save old buttons
    const acts = document.querySelector('#booking-modal .modal-actions');
    acts.dataset.old = acts.innerHTML;
    acts.innerHTML = `<button class="secondary" onclick="closeModal('booking-modal'); this.parentElement.innerHTML=this.parentElement.dataset.old;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;
    document.getElementById('booking-modal').style.display='flex';
}
function confirmManualAdd(pid) {
    const court = courts[currentManualAddCourtIdx];
    const p = players.find(x=>x.id===pid);
    if(countRealPlayers(court)>=4) { alert('‡πÄ‡∏ï‡πá‡∏°'); return; }
    
    p.status='playing'; p.sessionGames=0; p.isFastPass=false;
    let emptyIdx = court.players.findIndex(x => x==null);
    if(emptyIdx !== -1) court.players[emptyIdx] = p; else court.players.push(p);
    
    closeModal('booking-modal');
    // Restore buttons
    const acts = document.querySelector('#booking-modal .modal-actions');
    if(acts.dataset.old) acts.innerHTML = acts.dataset.old;
    renderCourts(); saveData();
}

// ==========================================
// 8. SYNC & INIT
// ==========================================

function pushDataToCloud() {
    const state = { players, courts, courtCount, gameRule:document.getElementById('game-rule').value };
    google.script.run.syncSaveState(JSON.stringify(state));
}
function restoreState(json) {
    if(isModalOpen() || !json) return;
    const s = JSON.parse(json);
    players=s.players; courtCount=s.courtCount;
    if(s.gameRule) document.getElementById('game-rule').value = s.gameRule;
    courts = s.courts.map(c => ({...c, interval: null}));
    renderCourts();
}
function toggleBroadcast() {
    const btn = document.getElementById('btn-broadcast');
    if(syncInterval) {
        clearInterval(syncInterval); syncInterval=null;
        btn.innerHTML='üì° ‡πÄ‡∏£‡∏¥‡πà‡∏° Live'; btn.classList.remove('pulse');
    } else {
        if(!confirm('‡πÄ‡∏£‡∏¥‡πà‡∏° Live?')) return;
        syncInterval = setInterval(pushDataToCloud, 10000); pushDataToCloud();
        btn.innerHTML='üî¥ On Air'; btn.classList.add('pulse');
        const url = (typeof APP_URL!=='undefined'?APP_URL:location.href.split('?')[0]) + '?mode=viewer';
        document.getElementById('booking-inputs').innerHTML = `<p>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô:</p><input value="${url}" style="width:100%">`;
        document.getElementById('booking-modal').style.display='flex';
    }
}

function init() {
    if(isViewer) {
        document.body.classList.add('view-mode');
        google.script.run.withSuccessHandler(restoreState).syncLoadState();
        setInterval(() => google.script.run.withSuccessHandler(restoreState).syncLoadState(), 15000);
    } else {
        loadData();
        renderCourts();
        renderMatchLog(); // ‡∏ß‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢
        setInterval(() => { if(!isModalOpen()) { autoFillCourts(); saveData(); } }, 10000);
    }
}

init();
</script>